# 完整调用流程图

## 总览

```
用户输入
    ↓
[1] 入口层 (CLI)
    ↓
[2] 命令层 (Chat Command)
    ↓
[3] Skill层 (Executor)
    ↓
[4] Agent层 (BaseAgent)
    ↓
[5] 工具层 (Tools) ←→ [6] LLM层 (LLM Client)
    ↓
[7] Memory层 (Memory Manager)
    ↓
返回结果
```

---

## 详细流程图

### 完整调用链

```
┌─────────────────────────────────────────────────────────────┐
│ 用户操作: python -m cli chat                                 │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ [1] 入口层                                                   │
│                                                              │
│ cli/__main__.py                                             │
│   → cli/app.py (Typer应用)                                 │
│   → cli/commands/chat.py::main()                           │
│                                                              │
│ 职责: 解析命令行参数，路由到命令处理函数                      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ [2] 命令层                                                   │
│                                                              │
│ cli/commands/chat.py                                        │
│   1. show_banner() - 显示欢迎信息                           │
│   2. 生成session_id                                         │
│   3. 主循环:                                                │
│      while True:                                            │
│        user_input = console.input()                         │
│        if user_input.startswith("/"):                       │
│          handle_command() ─┐                                │
│        else:                │                                │
│          handle_chat() ────┘                                │
│                                                              │
│ 职责: 处理用户交互，管理会话                                  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ [2.1] 系统初始化 (handle_chat内)                            │
│                                                              │
│ daoyoucode/agents/init.py                                   │
│   → initialize_agent_system()                               │
│     1. 初始化工具注册表 (25个工具)                           │
│     2. 注册内置Agent (MainAgent等)                          │
│     3. 注册编排器 (ReAct等)                                 │
│                                                              │
│ daoyoucode/agents/llm/config_loader.py                      │
│   → auto_configure()                                        │
│     1. 加载llm_config.yaml                                  │
│     2. 注册LLM提供商 (通义千问等)                            │
│                                                              │
│ 职责: 一次性初始化所有系统组件                                │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ [3] Skill层                                                  │
│                                                              │
│ daoyoucode/agents/executor.py                               │
│   → execute_skill("chat_assistant", user_input, ...)       │
│                                                              │
│ 流程:                                                        │
│   1. 加载Skill配置 (skills/chat-assistant/skill.yaml)      │
│   2. 获取编排器 (orchestrator: react)                       │
│   3. 获取Agent (agent: MainAgent)                          │
│   4. 加载Prompt (prompts/chat_assistant.md)                │
│   5. 准备工具列表 (tools: [repo_map, read_file, ...])     │
│   6. 准备LLM配置 (llm: {model, temperature, ...})          │
│   7. 调用编排器执行                                          │
│                                                              │
│ 职责: 任务编排，配置管理                                      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ [3.1] 编排器执行                                             │
│                                                              │
│ daoyoucode/agents/orchestrators/react.py                    │
│   → ReActOrchestrator.execute()                            │
│                                                              │
│ 流程:                                                        │
│   1. 调用Agent.execute()                                    │
│   2. 监控执行过程                                            │
│   3. 处理错误和重试                                          │
│                                                              │
│ 职责: 控制Agent执行流程                                       │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ [4] Agent层                                                  │
│                                                              │
│ daoyoucode/agents/core/agent.py                             │
│   → BaseAgent.execute()                                     │
│                                                              │
│ 流程:                                                        │
│   ┌─────────────────────────────────────────┐              │
│   │ 1. 加载记忆                              │              │
│   │    - 对话历史 (最近3轮)                  │              │
│   │    - 用户偏好                            │              │
│   │    - 任务历史 (最近5个)                  │              │
│   └─────────────────────────────────────────┘              │
│                    ↓                                         │
│   ┌─────────────────────────────────────────┐              │
│   │ 2. 加载并渲染Prompt                      │              │
│   │    - 从文件加载                          │              │
│   │    - Jinja2模板渲染                      │              │
│   └─────────────────────────────────────────┘              │
│                    ↓                                         │
│   ┌─────────────────────────────────────────┐              │
│   │ 3. 调用LLM                               │              │
│   │    if tools:                             │              │
│   │      → _call_llm_with_tools() ─────┐    │              │
│   │    else:                            │    │              │
│   │      → _call_llm()                  │    │              │
│   └─────────────────────────────────────┘    │              │
│                    ↓                          │              │
│   ┌─────────────────────────────────────────┐│              │
│   │ 4. 保存记忆                              ││              │
│   │    - 保存对话                            ││              │
│   │    - 保存任务                            ││              │
│   │    - 学习偏好                            ││              │
│   └─────────────────────────────────────────┘│              │
│                                               │              │
│ 职责: 智能决策，记忆管理，LLM调用             │              │
└───────────────────────────────────────────────┘              │
                            ↓                   │              │
┌─────────────────────────────────────────────┐ │              │
│ [4.1] Function Calling循环                  │ │              │
│                                              │ │              │
│ BaseAgent._call_llm_with_tools()            │←┘              │
│                                              │                │
│ for iteration in range(max_iterations):     │                │
│   ┌──────────────────────────────────────┐  │                │
│   │ 1. 调用LLM (带functions参数)         │  │                │
│   │    → _call_llm_with_functions()      │  │                │
│   └──────────────────────────────────────┘  │                │
│                ↓                             │                │
│   ┌──────────────────────────────────────┐  │                │
│   │ 2. 检查function_call                 │  │                │
│   │    if 无 → 返回最终响应 ✓            │  │                │
│   │    if 有 → 继续                      │  │                │
│   └──────────────────────────────────────┘  │                │
│                ↓                             │                │
│   ┌──────────────────────────────────────┐  │                │
│   │ 3. 解析工具调用                      │  │                │
│   │    tool_name = function_call['name'] │  │                │
│   │    tool_args = json.loads(...)       │  │                │
│   └──────────────────────────────────────┘  │                │
│                ↓                             │                │
│   ┌──────────────────────────────────────┐  │                │
│   │ 4. 执行工具                          │  │                │
│   │    → tool_registry.execute_tool()    │──┐                │
│   └──────────────────────────────────────┘  │ │              │
│                ↓                             │ │              │
│   ┌──────────────────────────────────────┐  │ │              │
│   │ 5. 智能后处理 (新增)                 │  │ │              │
│   │    → tool_postprocessor.process()    │──┐│              │
│   │    - 提取关键词                      │  ││ │              │
│   │    - 过滤无关内容                    │  ││ │              │
│   │    - 保留最相关结果                  │  ││ │              │
│   └──────────────────────────────────────┘  ││ │              │
│                ↓                             ││ │              │
│   ┌──────────────────────────────────────┐  ││ │              │
│   │ 6. 添加到消息历史                    │  ││ │              │
│   │    messages.append({                 │  ││ │              │
│   │      "role": "assistant",            │  ││ │              │
│   │      "function_call": ...            │  ││ │              │
│   │    })                                │  ││ │              │
│   │    messages.append({                 │  ││ │              │
│   │      "role": "function",             │  ││ │              │
│   │      "content": tool_result          │  ││ │              │
│   │    })                                │  ││ │              │
│   └──────────────────────────────────────┘  ││ │              │
│                ↓                             ││ │              │
│   回到步骤1 (下一次迭代)                     ││ │              │
│                                              ││ │              │
│ 职责: 工具调用循环，直到LLM给出最终答案      ││ │              │
└──────────────────────────────────────────────┘│ │              │
                            ↓                   │ │              │
┌─────────────────────────────────────────────┐ │ │              │
│ [5] 工具层                                   │←┘ │              │
│                                              │   │              │
│ daoyoucode/agents/tools/base.py             │   │              │
│   → ToolRegistry.execute_tool()             │   │              │
│                                              │   │              │
│ 流程:                                        │   │              │
│   1. 获取工具实例                            │   │              │
│   2. 调用tool.execute(**kwargs)             │   │              │
│   3. 自动截断输出 (新增)                     │   │              │
│      - 字符限制 (MAX_OUTPUT_CHARS)          │   │              │
│      - 行数限制 (MAX_OUTPUT_LINES)          │   │              │
│      - 策略: head_tail / head_only / none   │   │              │
│   4. 返回ToolResult                         │   │              │
│                                              │   │              │
│ 具体工具:                                    │   │              │
│   - RepoMapTool (10000字符)                 │   │              │
│   - ReadFileTool (5000字符)                 │   │              │
│   - TextSearchTool (6000字符)               │   │              │
│   - ...                                     │   │              │
│                                              │   │              │
│ 职责: 工具执行，输出控制                      │   │              │
└──────────────────────────────────────────────┘   │              │
                            ↓                       │              │
┌─────────────────────────────────────────────┐   │              │
│ [5.1] 工具后处理                             │←──┘              │
│                                              │                  │
│ daoyoucode/agents/tools/postprocessor.py    │                  │
│   → ToolPostProcessor.process()             │                  │
│                                              │                  │
│ 流程:                                        │                  │
│   1. 提取关键词                              │                  │
│      - 支持中英文混合                        │                  │
│      - 移除停用词                            │                  │
│   2. 计算相关性                              │                  │
│      - 基于关键词匹配                        │                  │
│   3. 过滤内容                                │                  │
│      - RepoMap: 只保留相关文件               │                  │
│      - Search: 只保留相关匹配                │                  │
│      - ReadFile: 只保留相关section           │                  │
│   4. 返回优化后的结果                        │                  │
│                                              │                  │
│ 效果: Token节省40-70%                        │                  │
│                                              │                  │
│ 职责: 智能优化工具结果                        │                  │
└──────────────────────────────────────────────┘                  │
                                                                  │
┌─────────────────────────────────────────────┐                  │
│ [6] LLM层                                    │←─────────────────┘
│                                              │
│ daoyoucode/agents/llm/clients/unified.py    │
│   → UnifiedLLMClient.chat()                 │
│                                              │
│ 流程:                                        │
│   1. 构建请求payload                         │
│      - messages (多轮对话)                   │
│      - functions (Function schemas)         │
│      - temperature, max_tokens              │
│   2. 发送HTTP请求                            │
│      - POST /chat/completions               │
│      - OpenAI兼容格式                        │
│   3. 解析响应                                │
│      - content (文本响应)                    │
│      - function_call (工具调用)              │
│      - usage (token统计)                     │
│   4. 计算成本                                │
│   5. 返回LLMResponse                         │
│                                              │
│ 职责: LLM API调用，成本计算                   │
└──────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────┐
│ [7] Memory层                                 │
│                                              │
│ daoyoucode/agents/memory/__init__.py        │
│   → MemoryManager                           │
│                                              │
│ 存储:                                        │
│   - SQLite数据库 (.daoyoucode/memory/)      │
│                                              │
│ 表结构:                                      │
│   1. conversations (对话历史)                │
│      - session_id, user_message, ai_response│
│   2. preferences (用户偏好)                  │
│      - user_id, key, value                  │
│   3. tasks (任务历史)                        │
│      - user_id, task_data, timestamp        │
│                                              │
│ 操作:                                        │
│   - Agent执行前: 加载记忆                    │
│   - Agent执行后: 保存记忆                    │
│                                              │
│ 职责: 持久化存储，记忆管理                    │
└──────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────┐
│ 返回结果                                     │
│                                              │
│ Agent → Skill → Command → CLI → 用户        │
│                                              │
│ 显示:                                        │
│   - Rich Console渲染                         │
│   - Markdown格式化                           │
│   - 彩色输出                                 │
└──────────────────────────────────────────────┘
```

---

## 关键决策点

### 1. 是否使用工具？

```
Skill配置中的tools字段
├─ 有工具 → Function Calling循环
└─ 无工具 → 简单LLM调用
```

### 2. LLM是否调用工具？

```
LLM响应中的function_call字段
├─ 有 → 执行工具，继续循环
└─ 无 → 返回最终响应
```

### 3. 是否达到最大迭代次数？

```
iteration < max_iterations
├─ 是 → 继续循环
└─ 否 → 强制返回
```

### 4. 工具结果是否需要截断？

```
len(content) > MAX_OUTPUT_CHARS
├─ 是 → 截断（head_tail策略）
└─ 否 → 保持原样
```

### 5. 工具结果是否需要后处理？

```
tool_name in postprocessor.processors
├─ 是 → 智能过滤
└─ 否 → 保持原样
```

---

## 数据流

```
用户输入 (str)
    ↓
session_id (uuid)
    ↓
Skill配置 (yaml)
    ↓
Prompt模板 (md)
    ↓
记忆数据 (sqlite)
    ↓
LLM请求 (json)
    ↓
LLM响应 (json)
    ↓
工具调用 (function_call)
    ↓
工具结果 (ToolResult)
    ↓
后处理结果 (ToolResult)
    ↓
最终响应 (str)
    ↓
显示给用户 (Rich Console)
```

---

## 性能优化点

1. **工具输出截断** - 减少93%的无用内容
2. **智能后处理** - 额外减少30-50%的token
3. **记忆系统** - 只加载最近3轮对话
4. **HTTP连接池** - 复用连接，减少延迟
5. **SQLite缓存** - RepoMap避免重复解析

---

## 总结

整个调用链路包含7个层次：

1. **入口层** - CLI启动和参数解析
2. **命令层** - 用户交互和会话管理
3. **Skill层** - 任务编排和配置管理
4. **Agent层** - 智能决策和记忆管理
5. **工具层** - 实际执行和输出控制
6. **LLM层** - 模型调用和成本计算
7. **Memory层** - 持久化存储和记忆管理

每一层都有明确的职责，通过清晰的接口进行通信。
