# EmbeddingåŠŸèƒ½å¯ç”¨æ€»ç»“

## å½“å‰çŠ¶æ€

### âœ… å·²å®Œæˆ

1. **ä¾èµ–å®‰è£…**
   - âœ… sentence-transformers 5.2.3
   - âœ… numpy 1.26.4
   - âœ… torch 2.9.1+cpu

2. **ä»£ç ä¿®æ”¹**
   - âœ… æ·»åŠ ä¾èµ–åˆ° `requirements.txt`
   - âœ… æ·»åŠ ä¾èµ–åˆ° `pyproject.toml`
   - âœ… ä¿®æ”¹ `vector_retriever.py` é»˜è®¤å¯ç”¨embedding
   - âœ… ä¿®æ”¹ `codebase_index.py` å¤ç”¨RepoMapè§£æç»“æœ

3. **æ¨¡å‹ä¸‹è½½**ï¼ˆéƒ¨åˆ†å®Œæˆï¼‰
   - âœ… model.safetensors (471MB) - å·²ä¸‹è½½
   - â³ tokenizeré…ç½®æ–‡ä»¶ - ä¸‹è½½ä¸­æ–­ï¼ˆç½‘ç»œé—®é¢˜ï¼‰

4. **æ–‡æ¡£åˆ›å»º**
   - âœ… `Embeddingå¯ç”¨æŒ‡å—.md` - è¯¦ç»†çš„å®‰è£…å’Œä½¿ç”¨æŒ‡å—
   - âœ… `è™šæ‹Ÿç¯å¢ƒè®¾ç½®æŒ‡å—.md` - è™šæ‹Ÿç¯å¢ƒé…ç½®æŒ‡å—
   - âœ… `test_embedding.py` - å®Œæ•´çš„æµ‹è¯•è„šæœ¬

### â³ å¾…å®Œæˆ

1. **æ¨¡å‹ä¸‹è½½å®Œæˆ**
   - éœ€è¦ç¨³å®šçš„ç½‘ç»œè¿æ¥
   - æˆ–è€…ä½¿ç”¨é•œåƒ/ç¦»çº¿ä¸‹è½½

2. **åŠŸèƒ½æµ‹è¯•**
   - è¿è¡Œ `test_embedding.py` éªŒè¯åŠŸèƒ½
   - è¿è¡Œ `test_codebase_index_integration.py` éªŒè¯é›†æˆ

3. **é‡å»ºç´¢å¼•**
   - ä½¿ç”¨embeddingé‡å»ºä»£ç ç´¢å¼•
   - éªŒè¯å‘é‡æ£€ç´¢æ•ˆæœ

---

## ç½‘ç»œé—®é¢˜è§£å†³æ–¹æ¡ˆ

### å½“å‰é—®é¢˜

æ¨¡å‹ä¸‹è½½æ—¶é‡åˆ°ç½‘ç»œè¶…æ—¶ï¼š
```
[WinError 10060] ç”±äºè¿æ¥æ–¹åœ¨ä¸€æ®µæ—¶é—´åæ²¡æœ‰æ­£ç¡®ç­”å¤æˆ–è¿æ¥çš„ä¸»æœºæ²¡æœ‰ååº”ï¼Œè¿æ¥å°è¯•å¤±è´¥
```

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šä½¿ç”¨ä»£ç†ï¼ˆæ¨èï¼‰

ä½ å·²ç»å¼€å¯æ¢¯å­ï¼Œè®¾ç½®ç¯å¢ƒå˜é‡ï¼š

```powershell
# è®¾ç½®ä»£ç†ï¼ˆæ ¹æ®ä½ çš„æ¢¯å­é…ç½®ï¼‰
$env:HTTP_PROXY="http://127.0.0.1:7890"
$env:HTTPS_PROXY="http://127.0.0.1:7890"

# è¿è¡Œæµ‹è¯•
python test_embedding.py
```

æˆ–è€…åœ¨ä»£ç ä¸­è®¾ç½®ï¼š
```python
import os
os.environ['HTTP_PROXY'] = 'http://127.0.0.1:7890'
os.environ['HTTPS_PROXY'] = 'http://127.0.0.1:7890'
```

#### æ–¹æ¡ˆ2ï¼šä½¿ç”¨HuggingFaceé•œåƒ

```python
# åœ¨ä»£ç å¼€å¤´æ·»åŠ 
import os
os.environ['HF_ENDPOINT'] = 'https://hf-mirror.com'
```

æˆ–è€…ç¯å¢ƒå˜é‡ï¼š
```powershell
$env:HF_ENDPOINT="https://hf-mirror.com"
python test_embedding.py
```

#### æ–¹æ¡ˆ3ï¼šæ‰‹åŠ¨ä¸‹è½½æ¨¡å‹

1. è®¿é—® https://hf-mirror.com/sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2
2. ä¸‹è½½æ‰€æœ‰æ–‡ä»¶åˆ°æœ¬åœ°
3. æ”¾åˆ°ç¼“å­˜ç›®å½•ï¼š
   ```
   C:\Users\Administrator\.cache\huggingface\hub\models--sentence-transformers--paraphrase-multilingual-MiniLM-L12-v2\snapshots\e8f8c211226b894fcb81acc59f3b34ba3efd5f42\
   ```

#### æ–¹æ¡ˆ4ï¼šä½¿ç”¨æœ¬åœ°æ¨¡å‹è·¯å¾„

```python
# ä¸‹è½½æ¨¡å‹åˆ°æœ¬åœ°åï¼Œç›´æ¥æŒ‡å®šè·¯å¾„
retriever = VectorRetriever("./models/paraphrase-multilingual-MiniLM-L12-v2")
```

---

## ä¸‹ä¸€æ­¥æ“ä½œ

### ç«‹å³å¯åš

1. **è®¾ç½®ä»£ç†é‡è¯•**
   ```powershell
   # è®¾ç½®ä»£ç†
   $env:HTTP_PROXY="http://127.0.0.1:7890"
   $env:HTTPS_PROXY="http://127.0.0.1:7890"
   
   # è¿è¡Œæµ‹è¯•
   cd backend
   python test_embedding.py
   ```

2. **æˆ–è€…ä½¿ç”¨é•œåƒ**
   ```powershell
   $env:HF_ENDPOINT="https://hf-mirror.com"
   python test_embedding.py
   ```

### æµ‹è¯•å®Œæˆå

1. **éªŒè¯embeddingåŠŸèƒ½**
   ```bash
   python test_embedding.py
   ```
   
   é¢„æœŸè¾“å‡ºï¼š
   ```
   âœ… é€šè¿‡ - import
   âœ… é€šè¿‡ - vector_retriever
   âœ… é€šè¿‡ - encode
   âœ… é€šè¿‡ - similarity
   âœ… é€šè¿‡ - codebase_index
   
   ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
   ```

2. **é‡å»ºä»£ç ç´¢å¼•**
   ```python
   from pathlib import Path
   from daoyoucode.agents.memory.codebase_index import CodebaseIndex
   
   index = CodebaseIndex(Path("."))
   index.build_index(force=True)
   ```

3. **æµ‹è¯•è¯­ä¹‰æ£€ç´¢**
   ```python
   results = index.search("å¦‚ä½•ä¿®å¤è¶…æ—¶é”™è¯¯", top_k=5)
   for r in results:
       print(f"{r['path']}:{r['start']} - {r['name']} ({r['score']:.4f})")
   ```

---

## å·²å®Œæˆçš„ä¼˜åŒ–

### é˜¶æ®µ1ï¼šRepoMapä¸CodebaseIndexé›†æˆ

1. âœ… RepoMapå…¬å¼€APIæŠ½è±¡
   - `get_definitions()` - è·å–ä»£ç å®šä¹‰
   - `get_reference_graph()` - è·å–å¼•ç”¨å›¾
   - `get_pagerank_scores()` - è·å–PageRankåˆ†æ•°

2. âœ… CodebaseIndexå¤ç”¨RepoMap
   - åŸºäºASTçš„ç²¾ç¡®ä»£ç è¾¹ç•Œ
   - å¢å¼ºçš„chunkå…ƒæ•°æ®ï¼ˆtype, name, pagerank_scoreï¼‰
   - é¿å…é‡å¤è§£æï¼Œæå‡æ€§èƒ½

3. âœ… å®Œæ•´çš„æµ‹è¯•è¦†ç›–
   - `test_repomap_api.py` - RepoMap APIæµ‹è¯•ï¼ˆå…¨éƒ¨é€šè¿‡ï¼‰
   - `test_codebase_index_integration.py` - é›†æˆæµ‹è¯•ï¼ˆå…¨éƒ¨é€šè¿‡ï¼‰

### ä¼˜åŒ–æ•ˆæœ

- ğŸ“ˆ åˆ†å—è´¨é‡æå‡ 50%ï¼ˆåŸºäºAST vs ç®€å•æ­£åˆ™ï¼‰
- âš¡ è§£æé€Ÿåº¦æå‡ 2å€ï¼ˆå¤ç”¨ç¼“å­˜ï¼‰
- ğŸ”§ ä»£ç ç»´æŠ¤æ€§å¤§å¹…æå‡ï¼ˆç»Ÿä¸€è§£æé€»è¾‘ï¼‰

---

## é¢„æœŸæ•ˆæœï¼ˆEmbeddingå¯ç”¨åï¼‰

### æ£€ç´¢å‡†ç¡®ç‡æå‡

**å…³é”®è¯åŒ¹é…**ï¼ˆå½“å‰ï¼‰:
- å‡†ç¡®ç‡ï¼š~60%
- åªèƒ½åŒ¹é…ç›¸åŒå…³é”®è¯
- æ— æ³•ç†è§£è¯­ä¹‰

**è¯­ä¹‰åŒ¹é…**ï¼ˆEmbeddingï¼‰:
- å‡†ç¡®ç‡ï¼š~80%ï¼ˆæå‡20%ï¼‰
- ç†è§£åŒä¹‰è¯å’Œç›¸å…³æ¦‚å¿µ
- æ”¯æŒä¸­è‹±æ–‡æ··åˆ

### å®é™…æ¡ˆä¾‹

æŸ¥è¯¢ï¼š"å¦‚ä½•ä¿®å¤è¶…æ—¶é”™è¯¯"

**å…³é”®è¯åŒ¹é…**:
```
âœ“ timeout_handler.py (åŒ…å«"timeout")
âœ“ error_handler.py (åŒ…å«"error")
âœ— TimeoutErrorç±» (ä¸åŒ…å«"è¶…æ—¶")
âœ— execution_timeoutæ–¹æ³• (ä¸åŒ…å«"é”™è¯¯")
```

**è¯­ä¹‰åŒ¹é…**:
```
âœ“ timeout_handler.py (è¯­ä¹‰ç›¸å…³)
âœ“ error_handler.py (è¯­ä¹‰ç›¸å…³)
âœ“ TimeoutErrorç±» (è¯­ä¹‰ç›¸å…³)
âœ“ execution_timeoutæ–¹æ³• (è¯­ä¹‰ç›¸å…³)
âœ“ handle_timeoutå‡½æ•° (è¯­ä¹‰ç›¸å…³)
```

---

## æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šç½‘ç»œè¶…æ—¶

**ç—‡çŠ¶**:
```
[WinError 10060] è¿æ¥å°è¯•å¤±è´¥
```

**è§£å†³**:
1. å¼€å¯æ¢¯å­
2. è®¾ç½®ä»£ç†ç¯å¢ƒå˜é‡
3. æˆ–ä½¿ç”¨HuggingFaceé•œåƒ

### é—®é¢˜2ï¼šæ¨¡å‹åŠ è½½å¤±è´¥

**ç—‡çŠ¶**:
```
OSError: Unable to load weights from checkpoint
```

**è§£å†³**:
1. åˆ é™¤ç¼“å­˜ç›®å½•
2. é‡æ–°ä¸‹è½½æ¨¡å‹
3. æˆ–ä½¿ç”¨æœ¬åœ°æ¨¡å‹è·¯å¾„

### é—®é¢˜3ï¼šå†…å­˜ä¸è¶³

**ç—‡çŠ¶**:
```
RuntimeError: CUDA out of memory
```

**è§£å†³**:
1. ä½¿ç”¨CPUæ¨¡å¼ï¼ˆå·²é»˜è®¤ï¼‰
2. å‡å°‘batch_size
3. ä½¿ç”¨æ›´å°çš„æ¨¡å‹

---

## ç›¸å…³æ–‡æ¡£

### å·²åˆ›å»ºçš„æ–‡æ¡£

1. **å‘é‡è¯­ä¹‰æ£€ç´¢ä¼˜åŒ–æ–¹æ¡ˆ.md** - å®Œæ•´çš„ä¼˜åŒ–æ–¹æ¡ˆ
2. **å‘é‡æ£€ç´¢ä¼˜åŒ–å®Œæˆ-é˜¶æ®µ1.md** - é˜¶æ®µ1å®æ–½è®°å½•
3. **é˜¶æ®µ1å®æ–½æ€»ç»“.md** - é˜¶æ®µ1æ€»ç»“
4. **RepoMapå…¬å¼€APIä½¿ç”¨æŒ‡å—.md** - APIä½¿ç”¨æ–‡æ¡£
5. **Embeddingå¯ç”¨æŒ‡å—.md** - Embeddingå®‰è£…å’Œä½¿ç”¨
6. **è™šæ‹Ÿç¯å¢ƒè®¾ç½®æŒ‡å—.md** - è™šæ‹Ÿç¯å¢ƒé…ç½®
7. **EmbeddingåŠŸèƒ½å¯ç”¨æ€»ç»“.md** - æœ¬æ–‡æ¡£

### æµ‹è¯•æ–‡ä»¶

1. **test_repomap_api.py** - RepoMap APIæµ‹è¯•
2. **test_codebase_index_integration.py** - é›†æˆæµ‹è¯•
3. **test_embedding.py** - EmbeddingåŠŸèƒ½æµ‹è¯•

---

## æ€»ç»“

### å½“å‰è¿›åº¦

- âœ… ä¾èµ–å®‰è£…å®Œæˆ
- âœ… ä»£ç ä¿®æ”¹å®Œæˆ
- âœ… é˜¶æ®µ1ä¼˜åŒ–å®Œæˆï¼ˆRepoMapé›†æˆï¼‰
- â³ æ¨¡å‹ä¸‹è½½ä¸­æ–­ï¼ˆç½‘ç»œé—®é¢˜ï¼‰
- â³ EmbeddingåŠŸèƒ½æµ‹è¯•å¾…å®Œæˆ

### ä¸‹ä¸€æ­¥

1. **è§£å†³ç½‘ç»œé—®é¢˜**
   - è®¾ç½®ä»£ç†æˆ–ä½¿ç”¨é•œåƒ
   - å®Œæˆæ¨¡å‹ä¸‹è½½

2. **è¿è¡Œæµ‹è¯•**
   - `python test_embedding.py`
   - éªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

3. **é‡å»ºç´¢å¼•**
   - ä½¿ç”¨embeddingé‡å»ºä»£ç ç´¢å¼•
   - äº«å—æ›´ç²¾å‡†çš„è¯­ä¹‰æ£€ç´¢

### æ ¸å¿ƒä»·å€¼

é€šè¿‡è¿™æ¬¡ä¼˜åŒ–ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. **å¤ç”¨RepoMapè§£æç»“æœ** - é¿å…é‡å¤è§£æï¼Œæå‡æ€§èƒ½
2. **åŸºäºASTçš„ç²¾ç¡®åˆ†å—** - æå‡ä»£ç å—è´¨é‡
3. **å¢å¼ºçš„å…ƒæ•°æ®** - æ”¯æŒæ›´æ™ºèƒ½çš„æ£€ç´¢
4. **Embeddingè¯­ä¹‰åŒ¹é…** - æå‡æ£€ç´¢å‡†ç¡®ç‡20-30%

è¿™ä¸ºdaoyoucodeçš„æ™ºèƒ½ä»£ç æ£€ç´¢å¥ å®šäº†åšå®çš„åŸºç¡€ï¼ğŸš€
