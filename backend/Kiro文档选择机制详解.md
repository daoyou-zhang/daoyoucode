# Kiro æ–‡æ¡£é€‰æ‹©æœºåˆ¶è¯¦è§£

## é—®é¢˜ï¼šKiroæ˜¯å¦‚ä½•é€šè¿‡ç”¨æˆ·æ„å›¾ç¡®å®šä½¿ç”¨å“ªäº›æ–‡æ¡£çš„ï¼Ÿ

Kiroï¼ˆæˆ‘ï¼‰å¹¶ä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç³»ç»Ÿï¼Œè€Œæ˜¯ä½ æ­£åœ¨å¼€å‘çš„ **daoyoucode** ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚è®©æˆ‘è§£é‡Šä¸€ä¸‹ä½ çš„ç³»ç»Ÿæ˜¯å¦‚ä½•é€šè¿‡ç”¨æˆ·æ„å›¾æ¥é€‰æ‹©æ–‡æ¡£çš„ã€‚

---

## ä½ çš„ç³»ç»Ÿï¼ˆdaoyoucodeï¼‰çš„æ–‡æ¡£é€‰æ‹©æœºåˆ¶

### 1. å¤šå±‚æ¬¡çš„æ–‡æ¡£é€‰æ‹©ç­–ç•¥

ä½ çš„ç³»ç»Ÿä½¿ç”¨äº†å¤šç§ç­–ç•¥æ¥é€‰æ‹©ç›¸å…³æ–‡æ¡£ï¼š

```
ç”¨æˆ·è¾“å…¥
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1å±‚ï¼šæ„å›¾åˆ†ç±»ï¼ˆintent.pyï¼‰                          â”‚
â”‚ - LLMæ„å›¾åˆ†ç±»ï¼šunderstand_project, need_code_context â”‚
â”‚ - å…³é”®è¯åŒ¹é…ï¼šå…œåº•ç­–ç•¥                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬2å±‚ï¼šé¢„å–ç­–ç•¥ï¼ˆmulti_agent.pyï¼‰                     â”‚
â”‚ - full: æ–‡æ¡£+ç»“æ„+åœ°å›¾ï¼ˆ~16000å­—ç¬¦ï¼‰                  â”‚
â”‚ - medium: ç»“æ„+åœ°å›¾ï¼ˆ~10000å­—ç¬¦ï¼‰                     â”‚
â”‚ - light: åªåœ°å›¾ï¼ˆ~8000å­—ç¬¦ï¼‰                          â”‚
â”‚ - none: ä¸é¢„å–ï¼ˆ0å­—ç¬¦ï¼‰                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬3å±‚ï¼šæŒ‡å‘æ€§é¢„å–ï¼ˆexecutor.pyï¼‰                      â”‚
â”‚ - initial_files: ç”¨æˆ·æ‰“å¼€çš„æ–‡ä»¶                       â”‚
â”‚ - repo_map(chat_files=initial_files)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬4å±‚ï¼šæŒ‰é—®æ£€ç´¢ï¼ˆexecutor.pyï¼‰                        â”‚
â”‚ - semantic_code_search: è¯­ä¹‰æœç´¢ç›¸å…³ä»£ç å—             â”‚
â”‚ - æ³¨å…¥ semantic_code_chunks åˆ° context               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬5å±‚ï¼šå·¥å…·è°ƒç”¨ï¼ˆAgentæ‰§è¡Œæ—¶ï¼‰                         â”‚
â”‚ - text_search: å…³é”®è¯æœç´¢                            â”‚
â”‚ - read_file: è¯»å–å…·ä½“æ–‡ä»¶                            â”‚
â”‚ - repo_map: åŠ¨æ€ç”Ÿæˆä»£ç åœ°å›¾                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è¯¦ç»†æœºåˆ¶è§£æ

### æœºåˆ¶1ï¼šæ„å›¾åˆ†ç±»é©±åŠ¨é¢„å–ï¼ˆintent.pyï¼‰

**ä»£ç ä½ç½®**ï¼š`backend/daoyoucode/agents/intent.py`

```python
async def classify_intents(
    user_input: str,
    llm_config: Optional[Dict[str, Any]] = None,
    intent_definitions: Optional[Dict[str, str]] = None,
) -> List[str]:
    """
    å¯¹ç”¨æˆ·è¾“å…¥åšä¸€æ¬¡å®½æ³›æ„å›¾åˆ†ç±»ï¼Œè¿”å›å‘½ä¸­çš„æ„å›¾æ ‡ç­¾åˆ—è¡¨ã€‚
    """
    # æ„å›¾å®šä¹‰
    DEFAULT_INTENT_DEFINITIONS = {
        "understand_project": "ç”¨æˆ·æƒ³äº†è§£/æ¢ç´¢å½“å‰é¡¹ç›®",
        "need_code_context": "ç”¨æˆ·é—®é¢˜æ¶‰åŠä»£ç å®ç°ã€éœ€è¦çœ‹ä»£ç ä¸Šä¸‹æ–‡",
        "edit_or_write": "ç”¨æˆ·æ˜ç¡®è¦æ”¹ä»£ç ã€å†™æ–‡ä»¶",
        "general_chat": "ä¸€èˆ¬å¯¹è¯ã€é—®å€™ã€æ— å…³ä»£ç çš„é—²èŠ",
    }
    
    # è°ƒç”¨LLMè¿›è¡Œæ„å›¾åˆ†ç±»
    prompt = f"""
    ä½ æ˜¯ä¸€ä¸ªæ„å›¾åˆ†ç±»å™¨ã€‚æ ¹æ®ç”¨æˆ·è¾“å…¥ï¼Œåˆ¤æ–­å…¶æ„å›¾å±äºä¸‹é¢å“ªäº›ç±»å‹ï¼ˆå¯å¤šé€‰ï¼‰ã€‚
    
    æ„å›¾å®šä¹‰ï¼š
    - understand_project: {DEFAULT_INTENT_DEFINITIONS['understand_project']}
    - need_code_context: {DEFAULT_INTENT_DEFINITIONS['need_code_context']}
    - edit_or_write: {DEFAULT_INTENT_DEFINITIONS['edit_or_write']}
    - general_chat: {DEFAULT_INTENT_DEFINITIONS['general_chat']}
    
    åªè¾“å‡ºä¸€ä¸ª JSON å¯¹è±¡ï¼Œæ ¼å¼ï¼š{{"intents": ["æ„å›¾id1", "æ„å›¾id2"]}}
    
    ç”¨æˆ·è¾“å…¥ï¼š{user_input}
    """
    
    # è¿”å›ï¼š["understand_project", "need_code_context"]
```

**å·¥ä½œæµç¨‹**ï¼š

1. **ç”¨æˆ·è¾“å…¥** â†’ "ç†è§£ä¸‹å½“å‰é¡¹ç›®çš„æ¶æ„"
2. **LLMåˆ†æ** â†’ è¯†åˆ«æ„å›¾ï¼š`["understand_project"]`
3. **ç¡®å®šé¢„å–çº§åˆ«** â†’ `prefetch_level = "full"`
4. **é¢„å–æ–‡æ¡£** â†’ æ–‡æ¡£+ç»“æ„+åœ°å›¾

---

### æœºåˆ¶2ï¼šåŠ¨æ€é¢„å–ç²’åº¦ï¼ˆmulti_agent.pyï¼‰

**ä»£ç ä½ç½®**ï¼š`backend/daoyoucode/agents/orchestrators/multi_agent.py`

```python
# æ ¹æ®æ„å›¾ç¡®å®šé¢„å–çº§åˆ«
need_project_prefetch, intents, prefetch_level = await should_prefetch_project_understanding(
    skill, user_input_stripped, context
)

if prefetch_level == "full":
    # å®Œæ•´é¢„å–ï¼šæ–‡æ¡£+ç»“æ„+åœ°å›¾
    docs_tool = get_tool("discover_project_docs")
    struct_tool = get_tool("get_repo_structure")
    repo_map_tool = get_tool("repo_map")
    
    d = await docs_tool.execute(repo_path=".", max_doc_length=12000)
    s = await struct_tool.execute(repo_path=".", max_depth=3)
    r = await repo_map_tool.execute(repo_path=".")
    
    parts = [
        "ã€é¡¹ç›®æ–‡æ¡£ã€‘\n" + d.content[:8000],
        "ã€ç›®å½•ç»“æ„ã€‘\n" + s.content[:3500],
        "ã€ä»£ç åœ°å›¾ã€‘\n" + r.content[:4500]
    ]
    
    context["project_understanding_block"] = "\n\n".join(parts)

elif prefetch_level == "medium":
    # ä¸­ç­‰é¢„å–ï¼šç»“æ„+åœ°å›¾
    s = await struct_tool.execute(repo_path=".", max_depth=3)
    r = await repo_map_tool.execute(repo_path=".")
    
    parts = [
        "ã€ç›®å½•ç»“æ„ã€‘\n" + s.content[:4000],
        "ã€ä»£ç åœ°å›¾ã€‘\n" + r.content[:6000]
    ]

elif prefetch_level == "light":
    # è½»é‡é¢„å–ï¼šåªåœ°å›¾
    r = await repo_map_tool.execute(repo_path=".")
    parts = ["ã€ä»£ç åœ°å›¾ã€‘\n" + r.content[:8000]]
```

**é¢„å–çº§åˆ«æ˜ å°„**ï¼š

| æ„å›¾ | é¢„å–çº§åˆ« | é¢„å–å†…å®¹ | å­—ç¬¦æ•° | ä½¿ç”¨åœºæ™¯ |
|------|---------|---------|--------|---------|
| understand_project | full | æ–‡æ¡£+ç»“æ„+åœ°å›¾ | ~16000 | "äº†è§£é¡¹ç›®"ã€"é¡¹ç›®æ¶æ„" |
| need_code_context | medium | ç»“æ„+åœ°å›¾ | ~10000 | "æŸ¥çœ‹ç™»å½•é€»è¾‘"ã€"åˆ†æä»£ç " |
| edit_or_write | light | åªåœ°å›¾ | ~8000 | "ä¿®å¤Bug"ã€"æ·»åŠ åŠŸèƒ½" |
| general_chat | none | æ—  | 0 | "ä½ å¥½"ã€"ä½ èƒ½åšä»€ä¹ˆ" |

---

### æœºåˆ¶3ï¼šæŒ‡å‘æ€§é¢„å–ï¼ˆexecutor.pyï¼‰

**ä»£ç ä½ç½®**ï¼š`backend/daoyoucode/agents/executor.py`

```python
# æŒ‡å‘æ€§ï¼ˆCursor åŒçº§ï¼‰ï¼šè‹¥æœ‰ç„¦ç‚¹æ–‡ä»¶ï¼Œé¢„å– repo_map(chat_files=initial_files)
initial_files = context.get("initial_files") or []

if initial_files and isinstance(initial_files, list) and len(initial_files) > 0:
    try:
        repo_map_tool = registry.get_tool("repo_map")
        if repo_map_tool:
            # ğŸ”‘ å…³é”®ï¼šä¼ é€’ chat_files å‚æ•°
            res = await repo_map_tool.execute(
                repo_path=".", 
                chat_files=initial_files  # ç„¦ç‚¹æ–‡ä»¶
            )
            
            if res and getattr(res, "content", None):
                raw = res.content
                # æˆªæ–­åˆ°6000å­—ç¬¦
                context["focus_repo_map_content"] = (
                    (raw[:6000] + "â€¦") if len(raw) > 6000 else raw
                )
                
                logger.info(f"æŒ‡å‘æ€§: å·²é¢„å– repo_map(chat_files={len(initial_files)} ä¸ªæ–‡ä»¶)")
    except Exception as e:
        logger.warning(f"é¢„å– focus repo_map å¤±è´¥: {e}")
```

**å·¥ä½œåŸç†**ï¼š

1. **ç”¨æˆ·æ‰“å¼€æ–‡ä»¶** â†’ `initial_files = ["backend/agents/core/agent.py"]`
2. **repo_mapå·¥å…·** â†’ ä½¿ç”¨PageRankç®—æ³•ï¼Œç»™æ‰“å¼€çš„æ–‡ä»¶ **Ã—50æƒé‡**
3. **æ™ºèƒ½æ’åº** â†’ ä¼˜å…ˆè¿”å›ä¸ç„¦ç‚¹æ–‡ä»¶ç›¸å…³çš„ä»£ç å®šä¹‰
4. **æ³¨å…¥context** â†’ `focus_repo_map_content`

**è¿™å°±æ˜¯Cursorçš„"æŒ‡å‘æ€§"åŠŸèƒ½**ï¼š
- ç”¨æˆ·æ‰“å¼€æŸä¸ªæ–‡ä»¶
- ç³»ç»Ÿè‡ªåŠ¨é¢„å–ä¸è¯¥æ–‡ä»¶ç›¸å…³çš„ä»£ç 
- LLMçœ‹åˆ°çš„æ˜¯"ä»¥è¯¥æ–‡ä»¶ä¸ºä¸­å¿ƒ"çš„ä»£ç åœ°å›¾

---

### æœºåˆ¶4ï¼šæŒ‰é—®æ£€ç´¢ï¼ˆexecutor.pyï¼‰

**ä»£ç ä½ç½®**ï¼š`backend/daoyoucode/agents/executor.py`

```python
# æŒ‰é—®æ£€ç´¢ï¼ˆCursor åŒçº§ï¼‰ï¼šè‹¥ Skill å« semantic_code_search ä¸”ç”¨æˆ·æœ‰è¾“å…¥
skill_tools = getattr(skill, "tools", None) or []

if "semantic_code_search" in skill_tools and user_input and user_input.strip():
    try:
        sem_tool = registry.get_tool("semantic_code_search")
        if sem_tool:
            # ğŸ”‘ å…³é”®ï¼šä½¿ç”¨ç”¨æˆ·è¾“å…¥ä½œä¸ºæŸ¥è¯¢
            res = await sem_tool.execute(
                query=user_input.strip()[:500],  # ç”¨æˆ·é—®é¢˜
                top_k=6,  # è¿”å›å‰6ä¸ªæœ€ç›¸å…³çš„ä»£ç å—
                repo_path="."
            )
            
            if res and getattr(res, "content", None) and res.content:
                # æˆªæ–­åˆ°5000å­—ç¬¦
                context["semantic_code_chunks"] = (
                    (res.content[:5000] + "â€¦") if len(res.content) > 5000 else res.content
                )
                
                logger.info("æŒ‰é—®æ£€ç´¢: å·²æ³¨å…¥ semantic_code_chunks")
    except Exception as e:
        logger.warning(f"æŒ‰é—®æ£€ç´¢é¢„å–å¤±è´¥: {e}")
```

**å·¥ä½œåŸç†**ï¼š

1. **ç”¨æˆ·æé—®** â†’ "å¦‚ä½•ä¿®å¤ç™»å½•æ—¶çš„500é”™è¯¯ï¼Ÿ"
2. **è¯­ä¹‰æœç´¢** â†’ ä½¿ç”¨embeddingæ¨¡å‹æœç´¢ç›¸å…³ä»£ç å—
3. **è¿”å›top-k** â†’ æœ€ç›¸å…³çš„6ä¸ªä»£ç å—
4. **æ³¨å…¥context** â†’ `semantic_code_chunks`

**è¿™å°±æ˜¯Cursorçš„"æŒ‰é—®æ£€ç´¢"åŠŸèƒ½**ï¼š
- ç”¨æˆ·æé—®
- ç³»ç»Ÿè‡ªåŠ¨æœç´¢ç›¸å…³ä»£ç 
- LLMçœ‹åˆ°çš„æ˜¯"ä¸é—®é¢˜æœ€ç›¸å…³"çš„ä»£ç ç‰‡æ®µ

---

### æœºåˆ¶5ï¼šå·¥å…·è°ƒç”¨ï¼ˆAgentæ‰§è¡Œæ—¶ï¼‰

**ä»£ç ä½ç½®**ï¼š`backend/daoyoucode/agents/core/agent.py`

Agentåœ¨æ‰§è¡Œæ—¶å¯ä»¥åŠ¨æ€è°ƒç”¨å·¥å…·ï¼š

```python
# Agentå¯ä»¥è°ƒç”¨çš„å·¥å…·
tools = [
    "repo_map",           # ç”Ÿæˆä»£ç åœ°å›¾
    "get_repo_structure", # è·å–ç›®å½•ç»“æ„
    "text_search",        # æ–‡æœ¬æœç´¢
    "read_file",          # è¯»å–æ–‡ä»¶
    "regex_search",       # æ­£åˆ™æœç´¢
    # ...
]

# Agentæ ¹æ®éœ€è¦åŠ¨æ€è°ƒç”¨
response = await agent.execute(
    user_input="ä¿®å¤ç™»å½•Bug",
    tools=tools
)

# Agentå¯èƒ½çš„å·¥å…·è°ƒç”¨åºåˆ—ï¼š
# 1. text_search(query="login", file_pattern="*.py")
# 2. read_file(file_path="auth/login.py")
# 3. text_search(query="500 error")
# 4. read_file(file_path="auth/error_handler.py")
```

---

## å®Œæ•´çš„æ–‡æ¡£é€‰æ‹©æµç¨‹ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šç”¨æˆ·é—®"ç†è§£ä¸‹å½“å‰é¡¹ç›®"

```
1. æ„å›¾åˆ†ç±»ï¼ˆintent.pyï¼‰
   è¾“å…¥ï¼š"ç†è§£ä¸‹å½“å‰é¡¹ç›®"
   è¾“å‡ºï¼šintents = ["understand_project"]
   
2. ç¡®å®šé¢„å–çº§åˆ«ï¼ˆintent.pyï¼‰
   è¾“å…¥ï¼šintents = ["understand_project"]
   è¾“å‡ºï¼šprefetch_level = "full"
   
3. é¢„å–æ–‡æ¡£ï¼ˆmulti_agent.pyï¼‰
   - discover_project_docs() â†’ README.md, CONTRIBUTING.mdç­‰
   - get_repo_structure() â†’ ç›®å½•æ ‘
   - repo_map() â†’ ä»£ç åœ°å›¾
   
4. æ³¨å…¥context
   context["project_understanding_block"] = """
   ã€é¡¹ç›®æ–‡æ¡£ã€‘
   è¿™æ˜¯ä¸€ä¸ªAIç¼–ç¨‹åŠ©æ‰‹é¡¹ç›®...
   
   ã€ç›®å½•ç»“æ„ã€‘
   backend/
   â”œâ”€â”€ daoyoucode/
   â”‚   â”œâ”€â”€ agents/
   â”‚   â””â”€â”€ tools/
   
   ã€ä»£ç åœ°å›¾ã€‘
   backend/daoyoucode/agents/core/agent.py:
     class BaseAgent
     def execute()
   """
   
5. ä¸»Agentæ‰§è¡Œ
   - çœ‹åˆ° project_understanding_block
   - ç›´æ¥åŸºäºé¢„å–å†…å®¹å›ç­”
   - ä¸éœ€è¦å†è°ƒç”¨å·¥å…·
```

### ç¤ºä¾‹2ï¼šç”¨æˆ·é—®"ä¿®å¤ç™»å½•æ—¶çš„500é”™è¯¯"

```
1. æ„å›¾åˆ†ç±»ï¼ˆintent.pyï¼‰
   è¾“å…¥ï¼š"ä¿®å¤ç™»å½•æ—¶çš„500é”™è¯¯"
   è¾“å‡ºï¼šintents = ["edit_or_write", "need_code_context"]
   
2. ç¡®å®šé¢„å–çº§åˆ«ï¼ˆintent.pyï¼‰
   è¾“å…¥ï¼šintents = ["edit_or_write"]
   è¾“å‡ºï¼šprefetch_level = "light"
   
3. é¢„å–æ–‡æ¡£ï¼ˆmulti_agent.pyï¼‰
   - repo_map() â†’ åªé¢„å–ä»£ç åœ°å›¾ï¼ˆè½»é‡ï¼‰
   
4. æŒ‰é—®æ£€ç´¢ï¼ˆexecutor.pyï¼‰
   - semantic_code_search(query="ä¿®å¤ç™»å½•æ—¶çš„500é”™è¯¯")
   - è¿”å›æœ€ç›¸å…³çš„6ä¸ªä»£ç å—
   - æ³¨å…¥ semantic_code_chunks
   
5. æ™ºèƒ½é€‰æ‹©è¾…åŠ©Agentï¼ˆmulti_agent.pyï¼‰
   - å…³é”®è¯åŒ¹é…ï¼š"ä¿®å¤" â†’ programmer
   - é€‰æ‹©ï¼šprogrammer + code_analyzer
   
6. è¾…åŠ©Agentæ‰§è¡Œ
   - code_analyzer: åˆ†æå¯èƒ½çš„é”™è¯¯åŸå› 
   - programmer: æä¾›ä¿®å¤å»ºè®®
   
7. ä¸»Agentæ‰§è¡Œ
   - çœ‹åˆ° repo_mapï¼ˆè½»é‡ï¼‰
   - çœ‹åˆ° semantic_code_chunksï¼ˆç›¸å…³ä»£ç ï¼‰
   - çœ‹åˆ° helper_resultsï¼ˆè¾…åŠ©Agentå»ºè®®ï¼‰
   - ç»¼åˆåˆ†æï¼Œç»™å‡ºä¿®å¤æ–¹æ¡ˆ
```

### ç¤ºä¾‹3ï¼šç”¨æˆ·æ‰“å¼€æ–‡ä»¶åé—®"è¿™ä¸ªå‡½æ•°æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ"

```
1. æŒ‡å‘æ€§é¢„å–ï¼ˆexecutor.pyï¼‰
   - initial_files = ["backend/agents/core/agent.py"]
   - repo_map(chat_files=initial_files)
   - ç„¦ç‚¹æ–‡ä»¶æƒé‡Ã—50
   - æ³¨å…¥ focus_repo_map_content
   
2. æ„å›¾åˆ†ç±»ï¼ˆintent.pyï¼‰
   è¾“å…¥ï¼š"è¿™ä¸ªå‡½æ•°æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ"
   è¾“å‡ºï¼šintents = ["need_code_context"]
   
3. ç¡®å®šé¢„å–çº§åˆ«ï¼ˆintent.pyï¼‰
   è¾“å…¥ï¼šintents = ["need_code_context"]
   è¾“å‡ºï¼šprefetch_level = "medium"
   
4. é¢„å–æ–‡æ¡£ï¼ˆmulti_agent.pyï¼‰
   - get_repo_structure() â†’ ç›®å½•æ ‘
   - repo_map() â†’ ä»£ç åœ°å›¾ï¼ˆä¸­ç­‰ï¼‰
   
5. ä¸»Agentæ‰§è¡Œ
   - çœ‹åˆ° focus_repo_map_contentï¼ˆä»¥æ‰“å¼€æ–‡ä»¶ä¸ºä¸­å¿ƒï¼‰
   - çœ‹åˆ° repo_mapï¼ˆä¸­ç­‰ç²’åº¦ï¼‰
   - ç†è§£ä¸Šä¸‹æ–‡ï¼Œè§£é‡Šå‡½æ•°åŠŸèƒ½
```

---

## ä¸Cursorçš„å¯¹æ¯”

ä½ çš„ç³»ç»Ÿï¼ˆdaoyoucodeï¼‰å®ç°äº†ç±»ä¼¼Cursorçš„åŠŸèƒ½ï¼š

| åŠŸèƒ½ | Cursor | daoyoucode | å®ç°ä½ç½® |
|------|--------|-----------|---------|
| æ„å›¾åˆ†ç±» | âœ… | âœ… | intent.py |
| åŠ¨æ€é¢„å–ç²’åº¦ | âœ… | âœ… | multi_agent.py |
| æŒ‡å‘æ€§ï¼ˆç„¦ç‚¹æ–‡ä»¶ï¼‰ | âœ… | âœ… | executor.py + repo_map |
| æŒ‰é—®æ£€ç´¢ | âœ… | âœ… | executor.py + semantic_code_search |
| æ™ºèƒ½Agenté€‰æ‹© | âŒ | âœ… | multi_agent.py |
| è¾…åŠ©Agentåä½œ | âŒ | âœ… | multi_agent.py |

---

## å…³é”®æŠ€æœ¯

### 1. PageRankç®—æ³•ï¼ˆrepo_mapï¼‰

```python
# backend/daoyoucode/agents/tools/repomap_tools.py

def _pagerank(
    graph: Dict[str, Dict[str, float]],
    chat_files: List[str],  # ç„¦ç‚¹æ–‡ä»¶
    mentioned_idents: List[str],  # æåˆ°çš„æ ‡è¯†ç¬¦
):
    """
    PageRankç®—æ³•æ’åº
    
    ä¸ªæ€§åŒ–æƒé‡ï¼š
    - å¯¹è¯æ–‡ä»¶ï¼ˆç„¦ç‚¹æ–‡ä»¶ï¼‰ï¼šæƒé‡Ã—50
    - æåˆ°çš„æ ‡è¯†ç¬¦ï¼šæƒé‡Ã—10
    """
    
    personalization = {}
    for node in nodes:
        weight = 1.0
        
        # ç„¦ç‚¹æ–‡ä»¶æƒé‡Ã—50
        if node in chat_files:
            weight *= 50
        
        # æåˆ°çš„æ ‡è¯†ç¬¦æƒé‡Ã—10
        if mentioned_idents:
            # æ£€æŸ¥æ–‡ä»¶ä¸­çš„å®šä¹‰æ˜¯å¦åŒ…å«æåˆ°çš„æ ‡è¯†ç¬¦
            if node in definitions:
                file_defs = definitions[node]
                def_names = {d['name'].lower() for d in file_defs}
                mentioned_lower = {ident.lower() for ident in mentioned_idents}
                
                if def_names.intersection(mentioned_lower):
                    weight *= 10
        
        personalization[node] = weight
    
    # PageRankè¿­ä»£
    for _ in range(iterations):
        new_scores = {}
        for node in nodes:
            score = (1 - damping) * personalization[node]
            
            # æ¥è‡ªå…¶ä»–èŠ‚ç‚¹çš„åˆ†æ•°
            for source, targets in graph.items():
                if node in targets:
                    weight = targets[node]
                    out_weight = sum(targets.values())
                    score += damping * scores[source] * (weight / out_weight)
            
            new_scores[node] = score
        
        scores = new_scores
    
    return sorted(scores.items(), key=lambda x: x[1], reverse=True)
```

### 2. è¯­ä¹‰æœç´¢ï¼ˆsemantic_code_searchï¼‰

```python
# ä¼ªä»£ç ï¼Œå®é™…å®ç°å¯èƒ½åœ¨å…¶ä»–åœ°æ–¹

async def semantic_code_search(
    query: str,
    top_k: int = 6,
    repo_path: str = "."
):
    """
    è¯­ä¹‰æœç´¢ç›¸å…³ä»£ç å—
    
    1. å°†ä»£ç åˆ†å—ï¼ˆæŒ‰å‡½æ•°/ç±»ï¼‰
    2. ä½¿ç”¨embeddingæ¨¡å‹ç¼–ç 
    3. è®¡ç®—queryä¸ä»£ç å—çš„ç›¸ä¼¼åº¦
    4. è¿”å›top-kæœ€ç›¸å…³çš„ä»£ç å—
    """
    
    # 1. åˆ†å—
    code_chunks = split_code_into_chunks(repo_path)
    
    # 2. ç¼–ç 
    query_embedding = embed(query)
    chunk_embeddings = [embed(chunk) for chunk in code_chunks]
    
    # 3. è®¡ç®—ç›¸ä¼¼åº¦
    similarities = [
        cosine_similarity(query_embedding, chunk_embedding)
        for chunk_embedding in chunk_embeddings
    ]
    
    # 4. æ’åºå¹¶è¿”å›top-k
    top_chunks = sorted(
        zip(code_chunks, similarities),
        key=lambda x: x[1],
        reverse=True
    )[:top_k]
    
    return format_chunks(top_chunks)
```

---

## æ€»ç»“

ä½ çš„ç³»ç»Ÿï¼ˆdaoyoucodeï¼‰é€šè¿‡ä»¥ä¸‹æœºåˆ¶æ¥é€‰æ‹©æ–‡æ¡£ï¼š

1. **æ„å›¾åˆ†ç±»** â†’ ç†è§£ç”¨æˆ·æƒ³åšä»€ä¹ˆ
2. **åŠ¨æ€é¢„å–** â†’ æ ¹æ®æ„å›¾é¢„å–ä¸åŒç²’åº¦çš„æ–‡æ¡£
3. **æŒ‡å‘æ€§é¢„å–** â†’ æ ¹æ®ç”¨æˆ·æ‰“å¼€çš„æ–‡ä»¶é¢„å–ç›¸å…³ä»£ç 
4. **æŒ‰é—®æ£€ç´¢** â†’ æ ¹æ®ç”¨æˆ·é—®é¢˜æœç´¢ç›¸å…³ä»£ç 
5. **æ™ºèƒ½Agenté€‰æ‹©** â†’ æ ¹æ®æ„å›¾é€‰æ‹©åˆé€‚çš„è¾…åŠ©Agent
6. **å·¥å…·è°ƒç”¨** â†’ AgentåŠ¨æ€è°ƒç”¨å·¥å…·è·å–æ›´å¤šä¿¡æ¯

è¿™äº›æœºåˆ¶ååŒå·¥ä½œï¼Œç¡®ä¿LLMèƒ½å¤Ÿçœ‹åˆ°æœ€ç›¸å…³çš„æ–‡æ¡£ï¼Œä»è€Œç»™å‡ºå‡†ç¡®çš„ç­”æ¡ˆã€‚

**å…³é”®ä¼˜åŠ¿**ï¼š
- âœ… èŠ‚çœtokenï¼ˆä¸é¢„å–æ— å…³æ–‡æ¡£ï¼‰
- âœ… æé«˜å‡†ç¡®æ€§ï¼ˆåªçœ‹ç›¸å…³æ–‡æ¡£ï¼‰
- âœ… æå‡é€Ÿåº¦ï¼ˆå‡å°‘LLMå¤„ç†æ—¶é—´ï¼‰
- âœ… æ™ºèƒ½åŒ–ï¼ˆè‡ªåŠ¨åˆ¤æ–­éœ€è¦ä»€ä¹ˆæ–‡æ¡£ï¼‰

è¿™å°±æ˜¯ä½ çš„ç³»ç»Ÿå¦‚ä½•é€šè¿‡ç”¨æˆ·æ„å›¾æ¥ç¡®å®šä½¿ç”¨å“ªäº›æ–‡æ¡£çš„å®Œæ•´æœºåˆ¶ï¼
