# Memoryç³»ç»Ÿæ¶æ„

## æ¦‚è¿°

DaoyouCodeçš„Memoryç³»ç»Ÿé‡‡ç”¨**åˆ†å±‚å­˜å‚¨**æ¶æ„ï¼Œæ”¯æŒçŸ­æœŸã€ä¸­æœŸã€é•¿æœŸè®°å¿†ï¼Œä¸ºæ™ºèƒ½å¯¹è¯æä¾›å®Œæ•´çš„ä¸Šä¸‹æ–‡æ”¯æŒã€‚

## æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è®°å¿†ç³»ç»Ÿæ¶æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  çŸ­æœŸè®°å¿†    â”‚  â”‚  ä¸­æœŸè®°å¿†    â”‚  â”‚  é•¿æœŸè®°å¿†    â”‚ â”‚
â”‚  â”‚  (Session)   â”‚  â”‚  (æ‘˜è¦)      â”‚  â”‚  (ç”¨æˆ·ç”»åƒ)  â”‚ â”‚
â”‚  â”‚  å†…å­˜/æ–‡ä»¶   â”‚  â”‚  æ–‡ä»¶        â”‚  â”‚  æ–‡ä»¶        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                 â”‚                 â”‚           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                          â”‚                               â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                   â”‚  å¯¹è¯æ ‘      â”‚                       â”‚
â”‚                   â”‚  (è¯é¢˜åˆ†æ”¯)  â”‚                       â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                          â”‚                               â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                   â”‚  æ™ºèƒ½åŠ è½½å™¨  â”‚                       â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                          â”‚                               â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                   â”‚  ä¸Šä¸‹æ–‡ç»„è£…  â”‚                       â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                          â”‚                               â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                   â”‚  LLM Prompt â”‚                       â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒç»„ä»¶

### 1. MemoryManager (`manager.py`)
**èŒè´£**ï¼šè®°å¿†ç³»ç»Ÿæ€»æ§åˆ¶å™¨
- ç»Ÿä¸€çš„è®°å¿†ç®¡ç†æ¥å£
- åè°ƒå„ä¸ªå­ç³»ç»Ÿ
- Sessionå’ŒUserçº§åˆ«çš„æ•°æ®ç®¡ç†
- æŒä¹…åŒ–æ§åˆ¶

**æ•°æ®æ¨¡å‹**ï¼š
- Sessionçº§åˆ«ï¼šä¸´æ—¶å¯¹è¯æ•°æ®ï¼ˆå½“å‰ä¼šè¯ï¼‰
- Userçº§åˆ«ï¼šæ°¸ä¹…ç”¨æˆ·æ•°æ®ï¼ˆè·¨ä¼šè¯ï¼‰

### 2. ConversationTree (`conversation_tree.py`)
**èŒè´£**ï¼šå¯¹è¯æ ‘ç»“æ„ç®¡ç†
- ç»´æŠ¤å¯¹è¯çš„æ ‘å½¢ç»“æ„ï¼ˆåˆ†æ”¯ã€è¯é¢˜åˆ‡æ¢ï¼‰
- æ™ºèƒ½è¯†åˆ«è¯é¢˜åˆ‡æ¢ï¼ˆBM25 + å®ä½“è¯†åˆ«ï¼‰
- æ”¯æŒå¤šåˆ†æ”¯å¯¹è¯
- åŸºäºæ ‘ç»“æ„çš„ä¸Šä¸‹æ–‡æ£€ç´¢

**æ ¸å¿ƒç®—æ³•**ï¼š
- BM25ç›¸ä¼¼åº¦è®¡ç®—
- æ—¶é—´è¡°å‡æƒé‡
- åŠ¨æ€é˜ˆå€¼è°ƒæ•´
- å…³é”®å®ä½“è¯†åˆ«ï¼ˆå¦‚"çŒ«" vs "ç‹—"ï¼‰

### 3. SmartLoader (`smart_loader.py`)
**èŒè´£**ï¼šæ™ºèƒ½ä¸Šä¸‹æ–‡åŠ è½½
- æŒ‰éœ€åŠ è½½ç­–ç•¥ï¼ˆèŠ‚çœtokenæˆæœ¬ï¼‰
- å¤šç§åŠ è½½ç­–ç•¥ï¼š
  - æ–°å¯¹è¯ï¼šä¸åŠ è½½ï¼ˆCost: 0ï¼‰
  - ç®€å•è¿½é—®ï¼šåŠ è½½2è½®ï¼ˆCost: 1ï¼‰
  - ä¸­ç­‰è¿½é—®ï¼šåŠ è½½3è½®ï¼ˆCost: 2ï¼‰
  - å¤æ‚è¿½é—®ï¼šæ‘˜è¦+2è½®ï¼ˆCost: 3ï¼‰
- å‘é‡æ£€ç´¢æ”¯æŒï¼ˆå¯é€‰ï¼‰

**æˆæœ¬ä¼˜åŒ–**ï¼š
- ä¼ ç»Ÿæ–¹å¼ï¼šO(nÂ²)
- æ™ºèƒ½åŠ è½½ï¼šO(n)
- èŠ‚çœï¼š50-70%çš„tokenæˆæœ¬

### 4. BM25Matcher (`bm25_matcher.py`)
**èŒè´£**ï¼šè¯é¢˜ç›¸ä¼¼åº¦è®¡ç®—
- BM25ç®—æ³•ï¼ˆæ¯”Jaccardæ›´å‡†ç¡®ï¼‰
- æ—¶é—´è¡°å‡æƒé‡ï¼ˆè¶Šè¿‘çš„æ¶ˆæ¯æƒé‡è¶Šé«˜ï¼‰
- åŠ¨æ€é˜ˆå€¼ï¼ˆæ ¹æ®å†å²é•¿åº¦è°ƒæ•´ï¼‰
- å…³é”®å®ä½“è¯†åˆ«å’Œæƒ©ç½šæœºåˆ¶

**ä¼˜åŒ–**ï¼š
- æ”¯æŒjiebaåˆ†è¯ + bigram
- é™çº§åˆ°æ»‘åŠ¨çª—å£
- ä¿ç•™å•å­—åè¯ï¼ˆå¦‚"çŒ«"ã€"ç‹—"ï¼‰
- å®ä½“ä¸åŒ¹é…æ—¶é™ä½ç›¸ä¼¼åº¦70%

### 5. VectorRetriever (`vector_retriever.py`)
**èŒè´£**ï¼šå‘é‡è¯­ä¹‰æ£€ç´¢ï¼ˆå¯é€‰ï¼‰
- ä½¿ç”¨embeddingè¿›è¡Œè¯­ä¹‰åŒ¹é…
- æ¯”å…³é”®è¯åŒ¹é…æ›´ç²¾å‡†ï¼ˆå‡†ç¡®ç‡æå‡10-20%ï¼‰
- æ”¯æŒå¤šç§æ¨¡å‹ï¼ˆé»˜è®¤ï¼šparaphrase-multilingual-MiniLM-L12-v2ï¼‰
- è‡ªåŠ¨é™çº§ç­–ç•¥

### 6. UserManager (`user_manager.py`)
**èŒè´£**ï¼šç”¨æˆ·èº«ä»½ç®¡ç†
- ç”¨æˆ·IDç”Ÿæˆå’ŒéªŒè¯
- ç”¨æˆ·æ•°æ®ç›®å½•ç®¡ç†
- è·¨Sessionçš„ç”¨æˆ·æ•°æ®å…³è”

### 7. LongTermMemory (`long_term_memory.py`)
**èŒè´£**ï¼šé•¿æœŸè®°å¿†ç®¡ç†
- å¯¹è¯æ‘˜è¦ç”Ÿæˆ
- å…³é”®ä¿¡æ¯æå–
- ç”¨æˆ·ç”»åƒæ„å»º
- è·¨Sessionè®°å¿†

## æ•°æ®æµ

### å¯¹è¯æµç¨‹

```
ç”¨æˆ·æ¶ˆæ¯
   â”‚
   â–¼
è¿½é—®åˆ¤æ–­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                   â”‚
   â”œâ”€ æ˜¯è¿½é—®           â”‚
   â”‚   â”‚               â”‚
   â”‚   â–¼               â”‚
   â”‚ æ™ºèƒ½åŠ è½½          â”‚
   â”‚   â”œâ”€ æ£€æµ‹è¯é¢˜     â”‚
   â”‚   â”œâ”€ é€‰æ‹©ç­–ç•¥     â”‚
   â”‚   â”œâ”€ åŠ è½½ä¸Šä¸‹æ–‡   â”‚
   â”‚   â””â”€ å‘é‡æ£€ç´¢?    â”‚
   â”‚                   â”‚
   â””â”€ æ–°è¯é¢˜           â”‚
       â”‚               â”‚
       â–¼               â”‚
     å®Œæ•´Prompt        â”‚
       â”‚               â”‚
       â–¼               â”‚
     LLMç”Ÿæˆ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
   ä¿å­˜åˆ°è®°å¿†
       â”‚
       â”œâ”€ æ›´æ–°å¯¹è¯æ ‘
       â”œâ”€ ä¿å­˜Session
       â””â”€ æ›´æ–°Useræ•°æ®
```

### è¯é¢˜æ£€æµ‹æµç¨‹ï¼ˆå¯¹è¯æ ‘ï¼‰

```
æ–°æ¶ˆæ¯
   â”‚
   â–¼
æå–å…³é”®è¯å’Œå®ä½“
   â”‚
   â–¼
è®¡ç®—ä¸å½“å‰åˆ†æ”¯çš„ç›¸ä¼¼åº¦
   â”‚
   â”œâ”€ BM25åˆ†æ•°
   â”œâ”€ æ—¶é—´è¡°å‡æƒé‡
   â”œâ”€ å®ä½“åŒ¹é…æ£€æŸ¥
   â””â”€ åŠ¨æ€é˜ˆå€¼
   â”‚
   â–¼
ç›¸ä¼¼åº¦ >= é˜ˆå€¼ï¼Ÿ
   â”‚
   â”œâ”€ æ˜¯ â†’ ç»§ç»­å½“å‰åˆ†æ”¯
   â”‚
   â””â”€ å¦ â†’ åˆ›å»ºæ–°åˆ†æ”¯
```

## ä½¿ç”¨ç¤ºä¾‹

### 1. åŸºç¡€å¯¹è¯ï¼ˆå¸¦è¿½é—®ï¼‰

```python
from daoyoucode.agents.memory import get_memory_manager

memory = get_memory_manager()

# ç¬¬1è½®
memory.add_conversation(
    session_id="session_123",
    user_message="æˆ‘çš„çŒ«ä¸åƒé¥­",
    ai_response="å¯èƒ½æ˜¯è‚ èƒƒé—®é¢˜ï¼Œå»ºè®®è§‚å¯Ÿ...",
    user_id="user_001"
)

# ç¬¬2è½®ï¼ˆè¿½é—®ï¼‰
context = await memory.load_context_smart(
    session_id="session_123",
    user_id="user_001",
    user_input="éœ€è¦å»åŒ»é™¢å—ï¼Ÿ",
    is_followup=True
)
# è‡ªåŠ¨åŠ è½½ç›¸å…³ä¸Šä¸‹æ–‡
```

### 2. è¯é¢˜åˆ‡æ¢

```python
# ç¬¬1-2è½®ï¼šå…³äºçŒ«
memory.add_conversation(...)  # "æˆ‘çš„çŒ«ä¸åƒé¥­"
memory.add_conversation(...)  # "éœ€è¦å»åŒ»é™¢å—ï¼Ÿ"

# ç¬¬3è½®ï¼šåˆ‡æ¢åˆ°ç‹—ï¼ˆè‡ªåŠ¨åˆ›å»ºæ–°åˆ†æ”¯ï¼‰
memory.add_conversation(
    session_id="session_123",
    user_message="é‚£ç‹—å‘¢ï¼Ÿç‹—çš„çš®è‚¤æœ‰çº¢ç‚¹",
    ai_response="ç‹—çš„çš®è‚¤é—®é¢˜å¯èƒ½æ˜¯è¿‡æ•...",
    user_id="user_001"
)
# å¯¹è¯æ ‘è‡ªåŠ¨æ£€æµ‹è¯é¢˜åˆ‡æ¢ï¼Œåˆ›å»ºæ–°åˆ†æ”¯
```

### 3. æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯

```python
stats = memory.get_stats()
print(stats)
# {
#     'sessions': 1,
#     'users': 1,
#     'tree': {
#         'total_conversations': 3,
#         'total_branches': 2,
#         'current_branch_id': 'branch-xxx'
#     },
#     'loader': {
#         'total_loads': 2,
#         'average_cost': 1.5
#     }
# }
```

## é…ç½®å‚æ•°

### SmartLoader
```python
# ç®€å•è¿½é—®
simple_followup = {
    'history_limit': 2,  # åŠ è½½æœ€è¿‘2è½®
    'cost': 1
}

# ä¸­ç­‰è¿½é—®
medium_followup = {
    'history_limit': 3,  # åŠ è½½æœ€è¿‘3è½®
    'cost': 2
}

# å¤æ‚è¿½é—®
complex_followup = {
    'history_limit': 2,  # åŠ è½½æœ€è¿‘2è½®
    'load_summary': True,  # åŠ è½½æ‘˜è¦
    'cost': 3
}
```

### BM25Matcher
```python
bm25_config = {
    'base_threshold': 0.35,  # åŸºç¡€é˜ˆå€¼
    'time_decay_halflife': 120.0,  # 2åˆ†é’ŸåŠè¡°æœŸ
    'entity_penalty': 0.3  # å®ä½“ä¸åŒ¹é…æƒ©ç½š
}
```

### ConversationTree
```python
tree_config = {
    'enabled': True,  # æ˜¯å¦å¯ç”¨æ ‘ç»“æ„
    'detect_topic_switch': True  # æ˜¯å¦æ£€æµ‹è¯é¢˜åˆ‡æ¢
}
```

## æ€§èƒ½ä¼˜åŒ–

### 1. åˆ†å±‚åŠ è½½
- åªåœ¨éœ€è¦æ—¶åŠ è½½ä¸­é•¿æœŸè®°å¿†
- é¿å…æ¯æ¬¡éƒ½æŸ¥è¯¢æ‰€æœ‰å±‚çº§

### 2. æ™ºèƒ½ç­–ç•¥
- æ ¹æ®å¯¹è¯çŠ¶æ€é€‰æ‹©åŠ è½½ç­–ç•¥
- èŠ‚çœ50-70%çš„tokenæˆæœ¬

### 3. å‘é‡æ£€ç´¢ï¼ˆå¯é€‰ï¼‰
- è¯­ä¹‰åŒ¹é…æ›´ç²¾å‡†
- å‡†ç¡®ç‡æå‡10-20%

### 4. å¯¹è¯æ ‘ä¼˜åŒ–
- BM25ç®—æ³•æ¯”ç®€å•Jaccardæ›´å‡†ç¡®
- å®ä½“è¯†åˆ«é¿å…è¯¯åˆ¤
- æ—¶é—´è¡°å‡æƒé‡æé«˜ç›¸å…³æ€§

## ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡
- è¯é¢˜åˆ‡æ¢å‡†ç¡®ç‡
- ä¸Šä¸‹æ–‡åŠ è½½æˆæœ¬
- å‘é‡æ£€ç´¢å‘½ä¸­ç‡
- ç”¨æˆ·ç”»åƒè¦†ç›–ç‡

### æ—¥å¿—ç¤ºä¾‹
```
INFO: ğŸŒ¿ æ£€æµ‹åˆ°è¯é¢˜åˆ‡æ¢: ç‹—-çš®è‚¤é—®é¢˜
INFO: ğŸ“Š æ™ºèƒ½åŠ è½½: ç­–ç•¥=medium_followup, æˆæœ¬=2
INFO: ğŸ¯ å‘é‡åŒ¹é…: æ‰¾åˆ°2è½®ç›¸å…³å¯¹è¯
INFO: âœ… ä¿å­˜å¯¹è¯: session=session_123, branch=branch-xxx
```

## æ•…éšœå¤„ç†

### å‘é‡æ£€ç´¢ä¸å¯ç”¨
- è‡ªåŠ¨é™çº§åˆ°BM25 + å…³é”®è¯åŒ¹é…
- åŠŸèƒ½ä»ç„¶å¯ç”¨ï¼Œå‡†ç¡®ç‡ç•¥é™

### å¯¹è¯æ ‘ç¦ç”¨
- é™çº§åˆ°ç®€å•çš„çº¿æ€§å†å²
- æ™ºèƒ½åŠ è½½ä»ç„¶å·¥ä½œ

### æ–‡ä»¶ç³»ç»Ÿé”™è¯¯
- å†…å­˜æ¨¡å¼ç»§ç»­å·¥ä½œ
- æ•°æ®ä¸æŒä¹…åŒ–

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„åŠ è½½ç­–ç•¥

åœ¨`SmartLoader`ä¸­æ·»åŠ ï¼š
```python
async def _load_custom_strategy(self, ...):
    # è‡ªå®šä¹‰åŠ è½½é€»è¾‘
    return history, cost
```

### è°ƒæ•´è¯é¢˜æ£€æµ‹é˜ˆå€¼

ä¿®æ”¹`BM25Matcher`ï¼š
```python
base_threshold = 0.4  # æé«˜é˜ˆå€¼ï¼Œæ›´å®¹æ˜“åˆ‡æ¢è¯é¢˜
```

### è‡ªå®šä¹‰å®ä½“è¯†åˆ«

åœ¨`BM25Matcher._extract_key_entities`ä¸­æ·»åŠ ï¼š
```python
key_entities = {'çŒ«', 'ç‹—', 'é¸Ÿ', 'é±¼', 'ä½ çš„å®ä½“'}
```

## æµ‹è¯•

```bash
# å¯¹è¯æ ‘æµ‹è¯•
python backend/test_conversation_tree.py

# ç”¨æˆ·ç®¡ç†æµ‹è¯•
python backend/test_user_manager.py

# é›†æˆæµ‹è¯•
pytest backend/tests/test_memory_integration.py
```

## æ€»ç»“

Memoryç³»ç»Ÿæ˜¯DaoyouCodeçš„æ ¸å¿ƒèƒ½åŠ›ä¹‹ä¸€ï¼Œé€šè¿‡ï¼š

âœ… å¯¹è¯æ ‘ï¼šæ™ºèƒ½è¯é¢˜æ£€æµ‹å’Œåˆ†æ”¯ç®¡ç†
âœ… æ™ºèƒ½åŠ è½½ï¼šæŒ‰éœ€åŠ è½½ï¼ŒèŠ‚çœ50-70%æˆæœ¬
âœ… å‘é‡æ£€ç´¢ï¼šè¯­ä¹‰åŒ¹é…ï¼Œæå‡10-20%å‡†ç¡®ç‡
âœ… åˆ†å±‚å­˜å‚¨ï¼šçŸ­æœŸã€ä¸­æœŸã€é•¿æœŸè®°å¿†
âœ… ç”¨æˆ·ç”»åƒï¼šè·¨Sessionçš„ä¸ªæ€§åŒ–æœåŠ¡

å®ç°äº†**ä½æˆæœ¬ã€é«˜è´¨é‡ã€æ™ºèƒ½åŒ–**çš„å¯¹è¯ä½“éªŒã€‚

## ç›¸å…³æ–‡æ¡£

- [æ™ºèƒ½åŠ è½½ç­–ç•¥è¯¦è§£](./SMART_LOADING.md)
- [å‘é‡æ£€ç´¢ä½¿ç”¨æŒ‡å—](./VECTOR_RETRIEVAL.md)
- [å¯¹è¯æ ‘è®¾è®¡æ–‡æ¡£](../../MEMORY_CONVERSATION_TREE.md)
