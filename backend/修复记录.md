# 修复记录

## 2025-02-17 修复

### 问题1: 模型配置架构 ✅

**问题描述**:
- 用户希望在Skill配置文件中指定模型，而非在Agent代码中硬编码
- 更灵活、更易配置、更符合设计原则

**解决方案**:
1. 验证了现有架构已支持此功能
   - Skill配置文件中的 `llm.model` 会传递给Agent
   - Agent的 `execute()` 方法优先使用 `llm_config` 中的模型
   - Agent代码中的模型作为fallback默认值

2. 更新了文档
   - 创建 `模型配置架构说明.md` - 详细架构说明
   - 创建 `如何配置模型.md` - 快速配置指南
   - 更新 `README.md` - 添加文档导航

3. 修复了配置问题
   - 将 `skills/testing/skill.yaml` 中的 `deepseek-coder` 改为 `qwen-coder-plus`
   - 确保所有Skill使用已配置的模型

4. 创建了测试
   - `test_model_config.py` - 验证模型配置优先级
   - 所有测试通过 ✅

**配置优先级**:
```
Skill配置 (skill.yaml) → Agent默认 (agent.py) → 系统默认
```

**最佳实践**:
- ✅ 在Skill配置文件中明确指定模型
- ✅ Agent代码中使用通用默认模型（如 `qwen-plus`）
- ✅ 只使用已配置的模型（检查 `llm_config.yaml`）

---

### 问题2: 中间件导入错误 ✅

**问题描述**:
```
上下文管理失败: No module named 'ai'
```

**根本原因**:
- `ContextMiddleware` 中引用了不存在的模块：`from ai.memory.context_manager import ContextManager`
- 这是旧代码的遗留问题

**解决方案**:
1. 修复了导入路径
   - 从 `from ai.memory.context_manager import ContextManager`
   - 改为 `from ..memory import get_memory_manager`

2. 简化了实现
   - 使用已有的记忆管理系统（`MemoryManager`）
   - 移除了对不存在的 `ContextManager.get_history()` 的调用
   - 使用 `memory.get_conversation_history()` 获取历史

3. 创建了测试
   - `test_middleware_fix.py` - 验证中间件修复
   - 所有测试通过 ✅

**修复文件**:
- `backend/daoyoucode/agents/middleware/context.py`

**验证**:
```bash
cd backend
python test_middleware_fix.py
```

输出：
```
✅ ContextMiddleware 导入成功
✅ 中间件可以正常导入和注册
✅ 不再出现 'No module named ai' 错误
```

---

## 测试覆盖

### 1. 模型配置测试 (`test_model_config.py`)

测试内容：
- ✅ Skill配置的模型优先于Agent默认模型
- ✅ 没有Skill配置时使用Agent默认模型
- ✅ 部分配置正确合并（Skill配置 + Agent默认）
- ✅ Skill配置文件结构正确

运行：
```bash
cd backend
python test_model_config.py
```

### 2. 中间件修复测试 (`test_middleware_fix.py`)

测试内容：
- ✅ ContextMiddleware 可以正确导入
- ✅ FollowupMiddleware 可以正确导入
- ✅ 中间件可以正确注册
- ✅ ContextMiddleware 可以正常处理
- ✅ 不会出现 "No module named 'ai'" 错误

运行：
```bash
cd backend
python test_middleware_fix.py
```

### 3. 之前的修复测试 (`test_fixes.py`)

测试内容：
- ✅ 中间件注册
- ✅ JSON解析修复
- ✅ 模型配置

运行：
```bash
cd backend
python test_fixes.py
```

---

## 文档更新

### 新增文档

1. **模型配置架构说明.md**
   - 核心原则和架构流程
   - 配置优先级详解
   - 代码实现分析
   - 常见问题和解决方案

2. **如何配置模型.md**
   - 快速配置指南（3步）
   - 常见场景和示例
   - 常见错误和解决方案
   - 完整示例和检查清单

3. **修复记录.md** (本文档)
   - 问题描述和解决方案
   - 测试覆盖情况
   - 文档更新记录

### 更新文档

1. **README.md**
   - 添加了模型配置文档的导航
   - 更新了文档总览

2. **skills/testing/skill.yaml**
   - 将模型从 `deepseek-coder` 改为 `qwen-coder-plus`

---

## 架构改进

### 模型配置流程

```
用户执行命令
 ↓
python daoyoucode.py chat --skill testing
 ↓
加载 Skill 配置 (skills/testing/skill.yaml)
 ↓
llm:
  model: qwen-coder-plus  ← 在这里配置
  temperature: 0.3
 ↓
Orchestrator 传递配置
 ↓
llm_config=skill.llm
 ↓
Agent.execute()
 ↓
model = llm_config.get('model', self.config.model)
         ↑ 优先使用          ↑ fallback
 ↓
LLM Client
```

### 中间件架构

```
Skill 配置
 ↓
middleware:
  - context_management  ← 上下文管理
  - memory_integration  ← 记忆集成
  - followup           ← 追问判断
 ↓
Orchestrator 应用中间件
 ↓
ContextMiddleware.process()
 ↓
使用 MemoryManager 获取历史
 ↓
增强 context
 ↓
Agent.execute()
```

---

## 总结

### 完成的工作

1. ✅ 验证并文档化了模型配置架构
2. ✅ 修复了中间件导入错误
3. ✅ 创建了完整的测试覆盖
4. ✅ 更新了相关文档
5. ✅ 修复了配置问题

### 关键改进

1. **模型配置更灵活**
   - 在Skill配置文件中指定模型
   - Agent代码只提供默认值
   - 同一Agent可在不同Skill中使用不同模型

2. **中间件更稳定**
   - 修复了导入错误
   - 使用已有的记忆系统
   - 简化了实现

3. **文档更完善**
   - 架构说明文档
   - 快速配置指南
   - 测试和验证

### 最佳实践

1. **模型配置**
   - ✅ 在Skill配置文件中明确指定模型
   - ✅ Agent代码中使用通用默认模型
   - ✅ 只使用已配置的模型

2. **中间件开发**
   - ✅ 使用已有的系统模块（如MemoryManager）
   - ✅ 避免引用不存在的模块
   - ✅ 提供完整的错误处理

3. **测试驱动**
   - ✅ 为每个修复创建测试
   - ✅ 验证修复的正确性
   - ✅ 防止回归

---

## 下一步

建议的改进方向：

1. **性能优化**
   - 中间件缓存
   - 历史加载优化

2. **功能增强**
   - 更智能的上下文管理
   - 更精确的追问判断

3. **文档完善**
   - 添加更多示例
   - 视频教程

---

**修复完成时间**: 2025-02-17
**测试状态**: ✅ 所有测试通过
**文档状态**: ✅ 已更新


---

### 问题3: 工具参数占位符问题 ✅

**问题描述**:
```
执行工具: repo_map
repo_path  /path/to/your/repo
⚠️  工具返回错误: 仓库路径不存在: /path/to/your/repo
```

**根本原因**:
- LLM在调用工具时传了占位符参数 `/path/to/your/repo`
- 工具描述中没有明确说明应该使用 `.` 表示当前目录

**解决方案**:
1. 更新工具描述，明确说明使用方法
   - `repo_map`: "仓库根目录路径。使用 '.' 表示当前工作目录"
   - `get_repo_structure`: 同上
   - `get_project_docs`: 同上

2. 修复的文件：
   - `backend/daoyoucode/agents/tools/repomap_tools.py`
   - `backend/daoyoucode/agents/tools/project_docs_tools.py`

**验证**:
现在LLM应该知道使用 `.` 作为repo_path参数

---

### 问题4: LLM 500错误 ⚠️

**问题描述**:
```
执行失败: 连接错误: Server error '500 Internal Server Error' 
for url 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions'
```

**可能原因**:
1. API配额不足（检查阿里云账户余额）
2. 请求格式错误（特别是Function Calling格式）
3. 模型不支持Function Calling（某些模型不支持）
4. 请求过大（messages或functions太多）
5. 服务端临时故障（重试可能解决）

**诊断工具**:
创建了 `test_llm_connection.py` 用于诊断：
```bash
cd backend
python test_llm_connection.py
```

测试内容：
- ✅ API Key配置检查
- ✅ 简单LLM请求测试
- ✅ Function Calling测试
- ✅ 错误诊断建议

**建议的解决方案**:
1. 检查阿里云账户余额和配额
2. 尝试不使用Function Calling的简单请求
3. 减少messages历史长度（当前最多5轮）
4. 添加重试机制（已有超时重试）
5. 检查模型是否支持Function Calling

**注意**:
- 500错误通常是服务端问题，不是代码问题
- 如果简单请求成功但Function Calling失败，可能是模型不支持
- 建议使用 `qwen-max` 或 `qwen-plus`，它们完全支持Function Calling

---

## 更新的测试

### 4. LLM连接测试 (`test_llm_connection.py`)

测试内容：
- ✅ API Key配置检查
- ✅ 简单LLM请求
- ✅ Function Calling请求
- ✅ 500错误诊断

运行：
```bash
cd backend
python test_llm_connection.py
```

---

## 更新时间

**最后更新**: 2025-02-17 (新增问题3和问题4)


---

### 问题5: LLM使用占位符路径 ✅

**问题描述**:
```
repo_path  ./your-repo-path
⚠️  工具返回错误: 仓库路径不存在
```

**根本原因**:
- LLM在调用工具时使用了占位符路径 `your-repo-path`
- Prompt中没有明确说明应该使用 `.` 表示当前目录

**解决方案**:
1. 在Prompt中添加明确说明
   - "所有需要路径的工具，使用 `.` 表示当前工作目录"
   - 添加正确和错误的示例对比

2. 更新的文件：
   - `skills/sisyphus-orchestrator/prompts/sisyphus.md`

3. 添加的内容：
   - 工具使用示例（✅ 正确 vs ❌ 错误）
   - 明确说明当前工作目录就是项目根目录

**验证**:
重新运行后，LLM应该使用 `repo_map(repo_path=".")` 而不是占位符

---

### 问题6: API 500错误的真实原因 ⚠️

**API返回的错误**:
```json
{
  "error": {
    "message": "An internal error has occured, please try again later or contact service support.",
    "type": "internal_error",
    "code": "internal_error"
  }
}
```

**分析**:
这是阿里云API的真实内部错误，可能原因：
1. **请求过大** - Payload超过限制
2. **并发过高** - 同时请求太多
3. **服务端问题** - API临时故障
4. **配额限制** - 达到速率限制

**Debug工具**:
已添加详细的debug日志：
- 显示API Key使用情况
- 显示Payload大小
- 显示消息和Functions数量
- 保存完整请求到JSON文件

**使用方法**:
```bash
$env:DEBUG_LLM_REQUEST="1"
python daoyoucode.py chat --skill sisyphus-orchestrator
```

**临时解决方案**:
1. 减少历史消息数量
2. 减少工具数量（只保留5-10个）
3. 使用 `qwen-plus` 代替 `qwen-max`
4. 添加更多API Key轮询

---

## Debug工具

### 1. 请求日志

在 `unified.py` 中添加了详细的请求日志：
- API Key使用情况
- Payload大小
- 消息数量
- Functions数量

### 2. 完整请求保存

设置环境变量 `DEBUG_LLM_REQUEST=1` 会保存完整请求到JSON文件

### 3. 错误响应日志

500错误时会显示：
- 状态码
- URL
- 响应内容

### 4. Debug指南

创建了 `debug_500_error.md` 包含：
- 快速Debug步骤
- 常见问题排查
- 快速修复建议
- 测试方法

---

**最后更新**: 2025-02-17 (新增问题5和问题6，添加Debug工具)
