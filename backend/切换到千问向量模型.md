# 切换到千问向量模型指南

## 验证结果 ✅

已通过测试验证：
- ✅ 当前系统使用API模式（不依赖huggingface）
- ✅ 无huggingface或sentence_transformers模块被导入
- ✅ 使用httpx进行HTTP API调用
- ✅ 支持智谱AI、千问、OpenAI三种提供商

## 切换步骤

### 方法1: 直接修改配置文件（最简单）

**步骤1**: 打开配置文件
```
config/embedding_config.yaml
```

**步骤2**: 修改provider和api_key
```yaml
mode: "api"

api:
  provider: "qwen"  # 改为千问
  api_key: "YOUR_DASHSCOPE_API_KEY"  # 填入千问的API Key
```

**步骤3**: 保存并重启系统

**完成！** 系统会自动使用千问的向量模型。

### 方法2: 使用环境变量（更安全）

**步骤1**: 设置环境变量
```bash
# Windows CMD
set DASHSCOPE_API_KEY=your_api_key_here

# Windows PowerShell
$env:DASHSCOPE_API_KEY="your_api_key_here"
```

**步骤2**: 修改配置文件（不写api_key）
```yaml
mode: "api"

api:
  provider: "qwen"
  # api_key留空，从环境变量DASHSCOPE_API_KEY读取
```

**步骤3**: 重启系统

## 千问配置详情

```python
"qwen": {
    "base_url": "https://dashscope.aliyuncs.com/compatible-mode/v1",
    "model": "text-embedding-v3",
    "dimensions": 1024,
    "env_key": "DASHSCOPE_API_KEY"
}
```

**特点**:
- 向量维度: 1024（比智谱AI的2048小，但足够用）
- 阿里云生态，国内访问稳定
- 支持中英文
- 兼容OpenAI API格式

## 验证切换是否成功

**运行测试**:
```bash
cd backend
python test_api_mode_verification.py
```

**查看日志输出**:
```
✅ 向量检索已启用（API模式）
   提供商: qwen
   模型: text-embedding-v3
   维度: 1024
```

## 切换后需要做什么？

### 1. 重建代码库索引（必须）

不同模型的向量维度和语义空间不同，需要重建索引：

```bash
# 删除旧索引
rm -rf .daoyoucode/codebase_index

# 或者在Python中
import shutil
shutil.rmtree('.daoyoucode/codebase_index', ignore_errors=True)
```

下次使用时会自动重建索引（使用新模型）。

### 2. 无需重新安装依赖（确认）

所有API提供商共享相同的依赖：
- httpx（HTTP客户端）
- numpy（向量计算）
- pyyaml（配置读取）

这些依赖已经安装，无需额外操作。

## 三种提供商对比

| 提供商 | 模型 | 维度 | 优势 | 适用场景 |
|--------|------|------|------|---------|
| 智谱AI | embedding-3 | 2048 | 维度最高，中文效果好 | 中文为主的项目 |
| 千问 | text-embedding-v3 | 1024 | 阿里云生态，稳定 | 需要稳定性的生产环境 |
| OpenAI | text-embedding-3-small | 1536 | 国际标准，英文最优 | 英文为主的项目 |

## 常见问题

### Q1: 切换后原来的索引还能用吗？

**A**: 不能。不同模型的向量空间不兼容，必须重建索引。

### Q2: 切换需要多长时间？

**A**: 
- 修改配置: 1分钟
- 重建索引: 取决于代码库大小（通常1-5分钟）

### Q3: 可以随时切换回智谱AI吗？

**A**: 可以！只需改回配置文件：
```yaml
api:
  provider: "zhipu"
  api_key: "f7def1d8285a4b1da14f903a91a330a9.qwwPt8zwziMJIAmY"
```

### Q4: 如何获取千问的API Key？

**A**: 
1. 访问阿里云DashScope: https://dashscope.aliyun.com/
2. 注册/登录账号
3. 创建API Key
4. 复制到配置文件

### Q5: API调用失败会怎样？

**A**: 系统会自动回退到关键词匹配模式，不影响基本功能。

## 测试切换

**创建测试脚本**: `test_qwen_switch.py`

```python
from daoyoucode.agents.memory.vector_retriever_api import VectorRetrieverAPI

# 创建千问检索器
retriever = VectorRetrieverAPI(
    provider="qwen",
    api_key="YOUR_DASHSCOPE_API_KEY"
)

# 测试编码
text = "这是一个测试文本"
embedding = retriever.encode(text)

if embedding is not None:
    print(f"✅ 千问向量维度: {len(embedding)}")  # 应该是1024
    print(f"✅ 向量前5维: {embedding[:5]}")
    print("✅ 切换成功！")
else:
    print("❌ 切换失败，请检查API Key")
```

## 总结

✅ **确认**: 当前系统完全使用API模式，不依赖huggingface

✅ **切换**: 只需修改配置文件中的provider和api_key

✅ **依赖**: 无需重新安装，所有API共享相同依赖

✅ **灵活**: 可随时在智谱AI、千问、OpenAI之间切换

✅ **安全**: 支持环境变量方式管理API Key

---

**准备好切换了吗？** 提供千问的API Key，我可以帮你完成配置和测试。
