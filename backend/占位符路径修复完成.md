# å ä½ç¬¦è·¯å¾„é—®é¢˜ä¿®å¤å®Œæˆ

## é—®é¢˜å›é¡¾

LLMåœ¨è°ƒç”¨å·¥å…·æ—¶ä½¿ç”¨å ä½ç¬¦è·¯å¾„ï¼š
- `repo_map(repo_path="./your-repo-path")` âŒ
- `read_file(file_path="path/to/your/file.txt")` âŒ
- `text_search(directory="./src")` âŒ

## ä¿®å¤æ–¹æ¡ˆ

### 1. åœ¨Agent Promptå¼€å¤´æ·»åŠ å·¥å…·ä½¿ç”¨è§„åˆ™ â­â­â­â­â­

**æ–‡ä»¶**ï¼š`backend/daoyoucode/agents/core/agent.py`

**ä¿®æ”¹**ï¼šåœ¨`execute()`æ–¹æ³•ä¸­ï¼Œæ„å»º`full_prompt`æ—¶ï¼Œåœ¨æœ€å‰é¢æ·»åŠ å·¥å…·ä½¿ç”¨è§„åˆ™ï¼š

```python
# ğŸ†• æ·»åŠ å·¥å…·ä½¿ç”¨è§„åˆ™ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼Œæ”¾åœ¨Promptæœ€å‰é¢ï¼‰
if tools:
    tool_rules = """âš ï¸ å·¥å…·ä½¿ç”¨è§„åˆ™ï¼ˆå¿…é¡»éµå®ˆï¼‰ï¼š

1. è·¯å¾„å‚æ•°ä½¿ç”¨ '.' è¡¨ç¤ºå½“å‰å·¥ä½œç›®å½•
   - âœ… æ­£ç¡®ï¼šrepo_map(repo_path=".")
   - âŒ é”™è¯¯ï¼šrepo_map(repo_path="./your-repo-path")
   - âŒ é”™è¯¯ï¼šrepo_map(repo_path="/path/to/repo")

2. æ–‡ä»¶è·¯å¾„ä½¿ç”¨ç›¸å¯¹è·¯å¾„
   - âœ… æ­£ç¡®ï¼šread_file(file_path="backend/config.py")
   - âŒ é”™è¯¯ï¼šread_file(file_path="path/to/your/file.txt")

3. æœç´¢ç›®å½•ä½¿ç”¨ '.' æˆ–çœç•¥
   - âœ… æ­£ç¡®ï¼štext_search(query="example", directory=".")
   - âŒ é”™è¯¯ï¼štext_search(query="example", directory="./src")

è®°ä½ï¼šå½“å‰å·¥ä½œç›®å½•å°±æ˜¯é¡¹ç›®æ ¹ç›®å½•ï¼Œä¸éœ€è¦çŒœæµ‹è·¯å¾„ï¼

---

"""
    full_prompt = tool_rules + full_prompt
```

**ä¼˜ç‚¹**ï¼š
- æƒé‡æœ€é«˜ï¼ˆåœ¨Promptæœ€å‰é¢ï¼‰
- å¯¹æ‰€æœ‰å·¥å…·è°ƒç”¨ç”Ÿæ•ˆ
- ä¸ä¼šè¢«é•¿æ–‡æœ¬ç¨€é‡Š

### 2. åœ¨BaseToolä¸­æ·»åŠ è·¯å¾„éªŒè¯å’Œè‡ªåŠ¨ä¿®æ­£ â­â­â­â­

**æ–‡ä»¶**ï¼š`backend/daoyoucode/agents/tools/base.py`

**ä¿®æ”¹**ï¼šåœ¨`resolve_path()`æ–¹æ³•ä¸­æ·»åŠ å ä½ç¬¦æ£€æµ‹å’Œè‡ªåŠ¨ä¿®æ­£ï¼š

```python
def resolve_path(self, path: str) -> Path:
    """
    è§£æè·¯å¾„ï¼ˆä½¿ç”¨ ToolContextï¼‰
    
    è‡ªåŠ¨æ£€æµ‹å¹¶ä¿®æ­£å¸¸è§çš„å ä½ç¬¦è·¯å¾„é”™è¯¯ã€‚
    """
    # ğŸ†• æ£€æµ‹å ä½ç¬¦è·¯å¾„
    placeholder_patterns = [
        'your-repo-path',
        'your-project',
        'your-repo',
        'path/to/your',
        'path/to/file',
        'example/path',
        'example-path'
    ]
    
    path_lower = path.lower()
    for pattern in placeholder_patterns:
        if pattern in path_lower:
            self.logger.warning(
                f"âš ï¸  æ£€æµ‹åˆ°å ä½ç¬¦è·¯å¾„: {path}\n"
                f"   è‡ªåŠ¨ä¿®æ­£ä¸º: .\n"
                f"   æç¤ºï¼šè¯·ä½¿ç”¨ '.' è¡¨ç¤ºå½“å‰å·¥ä½œç›®å½•"
            )
            # è‡ªåŠ¨ä¿®æ­£ä¸ºå½“å‰å·¥ä½œç›®å½•
            return self.context.repo_path
    
    # ğŸ†• å»æ‰ ./ å‰ç¼€ï¼ˆå¦‚æœè·¯å¾„ä¸å­˜åœ¨ï¼‰
    if path.startswith('./'):
        clean_path = path[2:]
        full_path = self.context.repo_path / clean_path
        
        # å¦‚æœå»æ‰ ./ åçš„è·¯å¾„å­˜åœ¨ï¼Œä½¿ç”¨å®ƒ
        if not full_path.exists():
            self.logger.warning(
                f"âš ï¸  è·¯å¾„ä¸å­˜åœ¨: {path}\n"
                f"   å°è¯•å»æ‰ ./ å‰ç¼€: {clean_path}"
            )
            path = clean_path
    
    return self.context.abs_path(path)
```

**ä¼˜ç‚¹**ï¼š
- æœ€åä¸€é“é˜²çº¿
- è‡ªåŠ¨ä¿®æ­£å¸¸è§é”™è¯¯
- ä¸ä¾èµ–LLM
- æä¾›æ¸…æ™°çš„è­¦å‘Šä¿¡æ¯

## æµ‹è¯•ç»“æœ

è¿è¡Œ `python test_placeholder_fix.py`ï¼š

```
æµ‹è¯•è·¯å¾„: ./your-repo-path
âš ï¸  æ£€æµ‹åˆ°å ä½ç¬¦è·¯å¾„: ./your-repo-path
   è‡ªåŠ¨ä¿®æ­£ä¸º: .
   æç¤ºï¼šè¯·ä½¿ç”¨ '.' è¡¨ç¤ºå½“å‰å·¥ä½œç›®å½•
âœ… è‡ªåŠ¨ä¿®æ­£ä¸ºå½“å‰ç›®å½•

æµ‹è¯•è·¯å¾„: path/to/your/file.txt
âš ï¸  æ£€æµ‹åˆ°å ä½ç¬¦è·¯å¾„: path/to/your/file.txt
   è‡ªåŠ¨ä¿®æ­£ä¸º: .
   æç¤ºï¼šè¯·ä½¿ç”¨ '.' è¡¨ç¤ºå½“å‰å·¥ä½œç›®å½•
âœ… è‡ªåŠ¨ä¿®æ­£ä¸ºå½“å‰ç›®å½•

æµ‹è¯•è·¯å¾„: ./src
âš ï¸  è·¯å¾„ä¸å­˜åœ¨: ./src
   å°è¯•å»æ‰ ./ å‰ç¼€: src
âœ… è‡ªåŠ¨å»æ‰ ./ å‰ç¼€
```

## ä¸‹ä¸€æ­¥æµ‹è¯•

### 1. è¿è¡Œå®é™…çš„CLIæµ‹è¯•

```bash
cd backend
python daoyoucode.py chat --skill sisyphus-orchestrator
```

æµ‹è¯•ç”¨ä¾‹ï¼š
```
> ä½ å¥½ï¼Œå¸®æˆ‘çœ‹çœ‹é¡¹ç›®ç»“æ„
æœŸæœ›ï¼šrepo_map(repo_path=".")

> æœç´¢æ‰€æœ‰çš„Agentå®šä¹‰
æœŸæœ›ï¼štext_search(query="Agent", directory=".")

> è¯»å–LLMé…ç½®æ–‡ä»¶
æœŸæœ›ï¼šå…ˆæœç´¢ï¼Œç„¶å read_file(file_path="config/llm_config.yaml")
```

### 2. ä½¿ç”¨VSCodeè°ƒè¯•å™¨è¿½è¸ª

å¦‚æœLLMä»ç„¶ä½¿ç”¨å ä½ç¬¦è·¯å¾„ï¼š
1. åœ¨ `.vscode/launch.json` ä¸­å¯åŠ¨è°ƒè¯•
2. åœ¨ `backend/daoyoucode/agents/core/agent.py` çš„ `_call_llm_with_tools` æ–¹æ³•è®¾ç½®æ–­ç‚¹
3. æŸ¥çœ‹ `messages` å’Œ `function_schemas` çš„å†…å®¹
4. ç¡®è®¤å·¥å…·ä½¿ç”¨è§„åˆ™æ˜¯å¦åœ¨Promptä¸­

### 3. æ£€æŸ¥DEBUGæ—¥å¿—

è®¾ç½®ç¯å¢ƒå˜é‡ï¼š
```bash
set DEBUG_LLM_REQUEST=1
python daoyoucode.py chat --skill sisyphus-orchestrator
```

æŸ¥çœ‹ç”Ÿæˆçš„ `debug_llm_request_*.json` æ–‡ä»¶ï¼Œæ£€æŸ¥ï¼š
- `messages` ä¸­æ˜¯å¦åŒ…å«å·¥å…·ä½¿ç”¨è§„åˆ™
- `functions` çš„æè¿°æ˜¯å¦æ­£ç¡®
- LLMçš„å“åº”ä¸­ `function_call.arguments` çš„å†…å®¹

## ä¿®å¤æ•ˆæœé¢„æœŸ

### åœºæ™¯1ï¼šLLMéµå®ˆè§„åˆ™ âœ…

LLMçœ‹åˆ°Promptå¼€å¤´çš„è§„åˆ™ï¼Œä½¿ç”¨æ­£ç¡®çš„è·¯å¾„ï¼š
```json
{
  "function_call": {
    "name": "repo_map",
    "arguments": "{\"repo_path\": \".\"}"
  }
}
```

### åœºæ™¯2ï¼šLLMä»ä½¿ç”¨å ä½ç¬¦ âš ï¸

LLMå¿½ç•¥è§„åˆ™ï¼Œä½¿ç”¨å ä½ç¬¦è·¯å¾„ï¼š
```json
{
  "function_call": {
    "name": "repo_map",
    "arguments": "{\"repo_path\": \"./your-repo-path\"}"
  }
}
```

ä½†æ˜¯ï¼Œ`BaseTool.resolve_path()` ä¼šè‡ªåŠ¨ä¿®æ­£ï¼š
```
âš ï¸  æ£€æµ‹åˆ°å ä½ç¬¦è·¯å¾„: ./your-repo-path
   è‡ªåŠ¨ä¿®æ­£ä¸º: .
   æç¤ºï¼šè¯·ä½¿ç”¨ '.' è¡¨ç¤ºå½“å‰å·¥ä½œç›®å½•
```

å·¥å…·ä»ç„¶èƒ½æ­£å¸¸æ‰§è¡Œï¼

### åœºæ™¯3ï¼šLLMä½¿ç”¨ ./src âš ï¸

LLMä½¿ç”¨ `./src`ï¼ˆä¸å­˜åœ¨çš„è·¯å¾„ï¼‰ï¼š
```json
{
  "function_call": {
    "name": "text_search",
    "arguments": "{\"directory\": \"./src\"}"
  }
}
```

`BaseTool.resolve_path()` ä¼šè‡ªåŠ¨å»æ‰ `./` å‰ç¼€ï¼š
```
âš ï¸  è·¯å¾„ä¸å­˜åœ¨: ./src
   å°è¯•å»æ‰ ./ å‰ç¼€: src
```

å¦‚æœ `src` ç›®å½•å­˜åœ¨ï¼Œå·¥å…·æ­£å¸¸æ‰§è¡Œï¼›å¦‚æœä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯ã€‚

## æ€»ç»“

é€šè¿‡ä¸¤å±‚é˜²æŠ¤ï¼š
1. **Promptè§„åˆ™**ï¼ˆæ²»æœ¬ï¼‰ï¼šå¼•å¯¼LLMä½¿ç”¨æ­£ç¡®çš„è·¯å¾„æ ¼å¼
2. **å·¥å…·å±‚éªŒè¯**ï¼ˆæ²»æ ‡ï¼‰ï¼šè‡ªåŠ¨ä¿®æ­£å¸¸è§çš„é”™è¯¯è·¯å¾„

å³ä½¿LLMä»ç„¶ä½¿ç”¨å ä½ç¬¦è·¯å¾„ï¼Œå·¥å…·ä¹Ÿèƒ½è‡ªåŠ¨ä¿®æ­£å¹¶æ­£å¸¸æ‰§è¡Œã€‚

## ç›¸å…³æ–‡æ¡£

- `backend/PROMPTå ä½ç¬¦é—®é¢˜æ·±åº¦åˆ†æ.md` - é—®é¢˜åˆ†æå’Œè§£å†³æ–¹æ¡ˆ
- `backend/test_placeholder_fix.py` - æµ‹è¯•è„šæœ¬
- `backend/debug_500_error.md` - DebugæŒ‡å—

## ä¿®æ”¹çš„æ–‡ä»¶

1. `backend/daoyoucode/agents/core/agent.py` - æ·»åŠ å·¥å…·ä½¿ç”¨è§„åˆ™
2. `backend/daoyoucode/agents/tools/base.py` - æ·»åŠ è·¯å¾„éªŒè¯å’Œè‡ªåŠ¨ä¿®æ­£
3. `backend/test_placeholder_fix.py` - æµ‹è¯•è„šæœ¬ï¼ˆæ–°å»ºï¼‰
4. `backend/PROMPTå ä½ç¬¦é—®é¢˜æ·±åº¦åˆ†æ.md` - é—®é¢˜åˆ†æï¼ˆæ–°å»ºï¼‰
5. `backend/å ä½ç¬¦è·¯å¾„ä¿®å¤å®Œæˆ.md` - æœ¬æ–‡æ¡£ï¼ˆæ–°å»ºï¼‰
