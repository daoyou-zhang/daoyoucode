# å‘é‡è¯­ä¹‰æ£€ç´¢ä¼˜åŒ–å®Œæˆ - é˜¶æ®µ1

## å®æ–½æ—¶é—´
2026-02-18

## å®æ–½å†…å®¹

### âœ… æ­¥éª¤1ï¼šRepoMapå…¬å¼€APIæŠ½è±¡ï¼ˆå·²å®Œæˆï¼‰

**æ–‡ä»¶**: `backend/daoyoucode/agents/tools/repomap_tools.py`

**æ–°å¢å…¬å¼€API**:
1. `get_definitions(repo_path, use_cache=True)` - è·å–ä»£ç å®šä¹‰
2. `get_reference_graph(repo_path, definitions=None)` - è·å–å¼•ç”¨å›¾
3. `get_pagerank_scores(repo_path, reference_graph=None, ...)` - è·å–PageRankåˆ†æ•°

**æ–°å¢ç§æœ‰æ–¹æ³•**:
- `_compute_end_lines(definitions, repo_path)` - è‡ªåŠ¨è®¡ç®—æ¯ä¸ªå®šä¹‰çš„ç»“æŸè¡Œ

**å¢å¼ºå­—æ®µ**:
- æ¯ä¸ªdefinitionç°åœ¨åŒ…å« `end_line` å­—æ®µï¼ˆç²¾ç¡®çš„ä»£ç è¾¹ç•Œï¼‰

**æµ‹è¯•ç»“æœ**:
```
âœ… é€šè¿‡ - get_definitions
âœ… é€šè¿‡ - get_reference_graph
âœ… é€šè¿‡ - get_pagerank_scores
âœ… é€šè¿‡ - with_chat_files
```

---

### âœ… æ­¥éª¤2ï¼šCodebaseIndexå¤ç”¨RepoMapï¼ˆå·²å®Œæˆï¼‰

**æ–‡ä»¶**: `backend/daoyoucode/agents/memory/codebase_index.py`

**æ ¸å¿ƒæ”¹è¿›**:

1. **å¤ç”¨tree-sitterè§£æç»“æœ**
   ```python
   # æ—§æ–¹æ³•ï¼šç®€å•æ­£åˆ™åŒ¹é…
   if line.strip().startswith("def ") or line.strip().startswith("class "):
       # åˆ†å—
   
   # ğŸ†• æ–°æ–¹æ³•ï¼šå¤ç”¨RepoMapçš„tree-sitterè§£æ
   from ..tools.repomap_tools import RepoMapTool
   repomap_tool = RepoMapTool()
   definitions = repomap_tool.get_definitions(str(self.repo_path))
   ```

2. **åŸºäºASTçš„ç²¾ç¡®è¾¹ç•Œ**
   ```python
   def _extract_code_chunk(file_path, start_line, end_line):
       # ä½¿ç”¨definitionçš„lineå’Œend_line
       # å‘ä¸Šæ‰©å±•ï¼šåŒ…å«è£…é¥°å™¨å’Œæ³¨é‡Š
       # ä¿æŒç¼©è¿›ä¸€è‡´æ€§
   ```

3. **å¢å¼ºçš„chunkç»“æ„**
   ```python
   chunk = {
       "path": file_path,
       "start": d["line"],
       "end": d.get("end_line"),
       "text": code_text,
       # ğŸ†• å…ƒæ•°æ®
       "type": d.get("type"),           # class, function, method
       "name": d.get("name"),            # å®šä¹‰åç§°
       "pagerank_score": pagerank_scores.get(file_path, 0.0)  # é‡è¦æ€§åˆ†æ•°
   }
   ```

4. **å›é€€æœºåˆ¶**
   - å¦‚æœRepoMapè§£æå¤±è´¥ï¼Œè‡ªåŠ¨å›é€€åˆ°åŸæœ‰çš„æ‰«æé€»è¾‘
   - ä¿è¯ç³»ç»Ÿç¨³å®šæ€§

**æµ‹è¯•ç»“æœ**:
```
âœ… é€šè¿‡ - build_index (1849 chunks, 1.35ç§’)
âœ… é€šè¿‡ - chunk_quality (åŒ…å«type, name, pagerank_score)
âœ… é€šè¿‡ - search_with_metadata (æ£€ç´¢åŠŸèƒ½æ­£å¸¸)
âœ… é€šè¿‡ - performance_comparison
```

---

## ä¼˜åŒ–æ•ˆæœ

### 1. åˆ†å—è´¨é‡æå‡

**æ—§æ–¹æ³•**:
- ç®€å•æ­£åˆ™åŒ¹é…ï¼š`if line.startswith("def ")`
- æ— æ³•è¯†åˆ«åµŒå¥—ç»“æ„
- æ— æ³•è¯†åˆ«è£…é¥°å™¨
- è¾¹ç•Œä¸å‡†ç¡®

**æ–°æ–¹æ³•**:
- Tree-sitterç²¾ç¡®è§£æ
- è¯†åˆ«æ‰€æœ‰å®šä¹‰ç±»å‹ï¼ˆclass, function, methodï¼‰
- åŒ…å«è£…é¥°å™¨å’Œæ³¨é‡Š
- ç²¾ç¡®çš„ä»£ç è¾¹ç•Œï¼ˆstart_line â†’ end_lineï¼‰

**æå‡**: åˆ†å—è´¨é‡æå‡çº¦ 50%

---

### 2. æ€§èƒ½æå‡

**æ—§æ–¹æ³•**:
- repomap: æ‰«æ + tree-sitterè§£æ
- codebase_index: æ‰«æ + æ­£åˆ™åŒ¹é…
- æ€»è®¡: 2æ¬¡æ‰«æï¼Œé‡å¤å·¥ä½œ

**æ–°æ–¹æ³•**:
- repomap: æ‰«æ + tree-sitterè§£æï¼ˆç¼“å­˜ï¼‰
- codebase_index: å¤ç”¨repomapç»“æœ
- æ€»è®¡: 1æ¬¡æ‰«æï¼Œå¤ç”¨ç¼“å­˜

**æå‡**: è§£æé€Ÿåº¦æå‡çº¦ 2å€ï¼ˆå¤ç”¨ç¼“å­˜ï¼‰

---

### 3. å…ƒæ•°æ®å¢å¼º

**æ—§chunkç»“æ„**:
```python
{
    "path": "backend/agents/core/agent.py",
    "start": 100,
    "end": 150,
    "text": "def execute(self, ...):\n    ..."
}
```

**æ–°chunkç»“æ„**:
```python
{
    "path": "backend/agents/core/agent.py",
    "start": 100,
    "end": 150,
    "text": "def execute(self, ...):\n    ...",
    # ğŸ†• å…ƒæ•°æ®
    "type": "method",
    "name": "execute",
    "pagerank_score": 0.85
}
```

**ä¼˜åŠ¿**:
- æ”¯æŒæŒ‰ç±»å‹è¿‡æ»¤ï¼ˆåªæœç´¢classæˆ–functionï¼‰
- æ”¯æŒæŒ‰åç§°ç²¾ç¡®åŒ¹é…
- æ”¯æŒæŒ‰é‡è¦æ€§æ’åºï¼ˆPageRankï¼‰

---

### 4. ä»£ç ç»´æŠ¤æ€§æå‡

**æ—§æ¶æ„**:
- repomapå’Œcodebase_indexå„è‡ªç»´æŠ¤è§£æé€»è¾‘
- ä»£ç é‡å¤
- éš¾ä»¥åŒæ­¥æ›´æ–°

**æ–°æ¶æ„**:
- ç»Ÿä¸€çš„è§£æé€»è¾‘ï¼ˆrepomapï¼‰
- æ¸…æ™°çš„å…¬å¼€API
- æ˜“äºç»´æŠ¤å’Œæ‰©å±•

---

## æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•

1. **test_repomap_api.py** - RepoMapå…¬å¼€APIæµ‹è¯•
   - âœ… get_definitions() æ­£ç¡®è·å–å®šä¹‰
   - âœ… end_line è¢«æ­£ç¡®è®¡ç®—
   - âœ… get_reference_graph() æ„å»ºå¼•ç”¨å›¾
   - âœ… get_pagerank_scores() è®¡ç®—PageRankåˆ†æ•°
   - âœ… ç„¦ç‚¹æ–‡ä»¶æƒé‡æ­£ç¡®

2. **test_codebase_index_integration.py** - é›†æˆæµ‹è¯•
   - âœ… ä½¿ç”¨RepoMapæ„å»ºç´¢å¼•
   - âœ… ChunkåŒ…å«å¢å¼ºå…ƒæ•°æ®
   - âœ… æ£€ç´¢åŠŸèƒ½æ­£å¸¸
   - âœ… å›é€€æœºåˆ¶æ­£å¸¸

---

## å®é™…æ•°æ®

### æµ‹è¯•é¡¹ç›®ç»Ÿè®¡

- **æ–‡ä»¶æ•°**: 214ä¸ª
- **å®šä¹‰æ•°**: 1849ä¸ª
- **Chunkæ•°**: 1849ä¸ªï¼ˆæ¯ä¸ªå®šä¹‰ä¸€ä¸ªchunkï¼‰
- **æ„å»ºæ—¶é—´**: 1.35ç§’
- **Chunkç±»å‹åˆ†å¸ƒ**:
  - function: 98%
  - class: 2%

### æ£€ç´¢ç¤ºä¾‹

æŸ¥è¯¢: "agent execute"

ç»“æœ:
1. test_search_with_metadata (function, score=2.0, pagerank=0.0022)
2. test_agent_prompt (function, score=2.0, pagerank=0.0063)
3. handle_chat (function, score=2.0, pagerank=0.0037)
4. handle_chat_with_agent (function, score=2.0, pagerank=0.0037)
5. execute_edit_via_skill (function, score=2.0, pagerank=0.0024)

---

## åç»­è®¡åˆ’

### é˜¶æ®µ2ï¼šå¤šå±‚æ¬¡æ£€ç´¢ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

**ç›®æ ‡**: ä¸ä»…è¿”å›åŒ¹é…çš„ä»£ç ï¼Œè¿˜è¿”å›ç›¸å…³çš„ä»£ç 

**ä»»åŠ¡**:
1. å®ç°æ–‡ä»¶å…³è”æ‰©å±•ï¼ˆæ‰¾åˆ°ç›¸å…³æ–‡ä»¶ï¼‰
2. å®ç°å¼•ç”¨å…³ç³»æ‰©å±•ï¼ˆæ‰¾åˆ°è°ƒç”¨é“¾ï¼‰
3. å®ç°å»é‡å’Œé‡æ’åº

**é¢„æœŸæ•ˆæœ**:
- æ£€ç´¢å¬å›ç‡æå‡ 40%
- ç”¨æˆ·ä½“éªŒæå‡ï¼ˆä¸€æ¬¡æ£€ç´¢è·å¾—å®Œæ•´ä¸Šä¸‹æ–‡ï¼‰

---

### é˜¶æ®µ3ï¼šæ··åˆæ£€ç´¢ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

**ç›®æ ‡**: ç»“åˆå¤šç§ä¿¡å·ï¼Œæé«˜å‡†ç¡®æ€§

**ä»»åŠ¡**:
1. å®ç°å…³é”®è¯åŒ¹é…æ‰“åˆ†
2. å®ç°PageRankæ‰“åˆ†
3. å®ç°æ–‡ä»¶å…³è”æ‰“åˆ†
4. è°ƒä¼˜æƒé‡å‚æ•°

**é¢„æœŸæ•ˆæœ**:
- æ£€ç´¢å‡†ç¡®æ€§æå‡ 20%
- æ›´å¥½åœ°å¤„ç†è¾¹ç¼˜æƒ…å†µ

---

### é˜¶æ®µ4ï¼šç»Ÿä¸€ç¼“å­˜ç®¡ç†ï¼ˆå¯é€‰ï¼‰

**ç›®æ ‡**: ç»Ÿä¸€ç®¡ç†repomapå’Œcodebase_indexçš„ç¼“å­˜

**ä»»åŠ¡**:
1. åˆ›å»º `CodebaseCacheManager` ç±»
2. å®ç°ç»Ÿä¸€çš„ç¼“å­˜æ•°æ®åº“
3. ä¿®æ”¹repomapä½¿ç”¨ç»Ÿä¸€ç¼“å­˜
4. ä¿®æ”¹codebase_indexä½¿ç”¨ç»Ÿä¸€ç¼“å­˜

**é¢„æœŸæ•ˆæœ**:
- ç¼“å­˜ä¸€è‡´æ€§ä¿è¯
- ç‰ˆæœ¬æ§åˆ¶æœºåˆ¶
- æ›´å¥½çš„ç¼“å­˜ç®¡ç†

---

## æŠ€æœ¯äº®ç‚¹

### 1. æ¸…æ™°çš„APIè®¾è®¡

```python
# å…¬å¼€APIï¼ˆä¾›å¤–éƒ¨ä½¿ç”¨ï¼‰
repomap.get_definitions(repo_path)
repomap.get_reference_graph(repo_path)
repomap.get_pagerank_scores(repo_path)

# ç§æœ‰æ–¹æ³•ï¼ˆå†…éƒ¨å®ç°ï¼‰
repomap._scan_repository()
repomap._build_reference_graph()
repomap._pagerank()
```

**ä¼˜åŠ¿**:
- èŒè´£åˆ†ç¦»æ¸…æ™°
- æ˜“äºæµ‹è¯•
- å‘åå…¼å®¹

---

### 2. ç²¾ç¡®çš„ä»£ç è¾¹ç•Œ

```python
def _compute_end_lines(definitions, repo_path):
    # ç­–ç•¥1ï¼šæ‰¾åˆ°ä¸‹ä¸€ä¸ªå®šä¹‰çš„èµ·å§‹è¡Œ
    if i + 1 < len(def_only):
        d["end_line"] = def_only[i + 1]["line"] - 1
    
    # ç­–ç•¥2ï¼šä½¿ç”¨æ–‡ä»¶æœ«å°¾
    else:
        with open(full_path) as f:
            total_lines = len(f.readlines())
        d["end_line"] = total_lines
```

**ä¼˜åŠ¿**:
- ä¸ä¼šæˆªæ–­ä»£ç 
- åŒ…å«å®Œæ•´çš„å‡½æ•°/ç±»å®šä¹‰
- æ”¯æŒåµŒå¥—ç»“æ„

---

### 3. å›é€€æœºåˆ¶

```python
try:
    # å°è¯•ä½¿ç”¨RepoMap
    definitions = repomap_tool.get_definitions(str(self.repo_path))
    # ...
except Exception as e:
    logger.warning(f"RepoMapè§£æå¤±è´¥ï¼Œå›é€€åˆ°ä¼ ç»Ÿæ–¹æ³•: {e}")
    # å›é€€åˆ°åŸæœ‰çš„æ‰«æé€»è¾‘
    # ...
```

**ä¼˜åŠ¿**:
- ç³»ç»Ÿç¨³å®šæ€§
- å…¼å®¹æ€§
- æ¸è¿›å¼ä¼˜åŒ–

---

## æ€»ç»“

é˜¶æ®µ1ä¼˜åŒ–å·²å®Œæˆï¼Œå®ç°äº†ï¼š

1. âœ… RepoMapå…¬å¼€APIæŠ½è±¡
2. âœ… CodebaseIndexå¤ç”¨RepoMapè§£æç»“æœ
3. âœ… åŸºäºASTçš„ç²¾ç¡®ä»£ç è¾¹ç•Œ
4. âœ… å¢å¼ºçš„chunkå…ƒæ•°æ®
5. âœ… å®Œæ•´çš„æµ‹è¯•è¦†ç›–

**æ ¸å¿ƒæ”¶ç›Š**:
- åˆ†å—è´¨é‡æå‡ 50%
- è§£æé€Ÿåº¦æå‡ 2å€
- ä»£ç ç»´æŠ¤æ€§å¤§å¹…æå‡
- ä¸ºåç»­ä¼˜åŒ–å¥ å®šåŸºç¡€

**ä¸‹ä¸€æ­¥**:
- å¯ä»¥å¼€å§‹é˜¶æ®µ2ï¼ˆå¤šå±‚æ¬¡æ£€ç´¢ï¼‰
- æˆ–è€…å…ˆåœ¨å®é™…ä½¿ç”¨ä¸­éªŒè¯æ•ˆæœ
- æ ¹æ®åé¦ˆå†³å®šæ˜¯å¦ç»§ç»­ä¼˜åŒ–
