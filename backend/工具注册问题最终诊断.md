# å·¥å…·æ³¨å†Œé—®é¢˜æœ€ç»ˆè¯Šæ–­

## é—®é¢˜ç°è±¡

åœ¨å®é™…è¿è¡Œchatå‘½ä»¤æ—¶ï¼Œ`repo_map` å·¥å…·æ‰¾ä¸åˆ°ï¼š
```
ğŸ”§ æ‰§è¡Œå·¥å…·: repo_map
   â³ æ­£åœ¨æ‰§è¡Œ...
   âœ— æ‰§è¡Œå¤±è´¥: Tool not found: repo_map
```

ä½†åœ¨æµ‹è¯•è„šæœ¬ä¸­ï¼Œå·¥å…·æ³¨å†Œæ­£å¸¸ã€‚

## å·²å®Œæˆçš„è¯Šæ–­

### 1. å·¥å…·æ³¨å†Œæµ‹è¯• âœ…
```bash
python backend/test_tool_registry.py
```
ç»“æœï¼š25ä¸ªå·¥å…·å…¨éƒ¨æ³¨å†Œï¼ŒåŒ…æ‹¬ `repo_map`

### 2. CLIç¯å¢ƒæµ‹è¯• âœ…
```bash
python backend/test_cli_env.py
```
ç»“æœï¼šå·¥å…·æ³¨å†Œæ­£å¸¸

### 3. å®Œæ•´æµç¨‹æµ‹è¯• âœ…
```bash
python backend/test_chat_flow.py
```
ç»“æœï¼šAgentç³»ç»Ÿæ­£å¸¸å·¥ä½œ

## å¯èƒ½çš„åŸå› 

### åŸå› 1: æ¨¡å—å¯¼å…¥é¡ºåºé—®é¢˜

å½“é€šè¿‡ `python -m cli.app chat` è¿è¡Œæ—¶ï¼Œæ¨¡å—å¯¼å…¥é¡ºåºå¯èƒ½ä¸åŒï¼š

**æµ‹è¯•è„šæœ¬**:
```python
# ç›´æ¥å¯¼å…¥
from daoyoucode.agents.tools import get_tool_registry
# æ­¤æ—¶ daoyoucode.agents.__init__.py å·²æ‰§è¡Œï¼Œå·¥å…·å·²æ³¨å†Œ
```

**CLIè¿è¡Œ**:
```python
# é€šè¿‡ cli.app â†’ cli.commands.chat â†’ daoyoucode.agents
# å¯èƒ½åœ¨æŸä¸ªæ—¶åˆ»å·¥å…·æ³¨å†Œè¡¨è¿˜æœªåˆå§‹åŒ–
```

### åŸå› 2: å¤šæ¬¡å¯¼å…¥å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´

å¯èƒ½åœ¨ä¸åŒçš„æ¨¡å—ä¸­å¤šæ¬¡è°ƒç”¨ `get_tool_registry()`ï¼Œä½†ç”±äºæŸç§åŸå› åˆ›å»ºäº†å¤šä¸ªå®ä¾‹ã€‚

### åŸå› 3: å¼‚æ­¥æ‰§è¡Œå¯¼è‡´çš„ç«æ€æ¡ä»¶

Agentåœ¨å¼‚æ­¥æ‰§è¡Œæ—¶ï¼Œå·¥å…·æ³¨å†Œè¡¨å¯èƒ½è¿˜åœ¨åˆå§‹åŒ–ä¸­ã€‚

## å·²å®æ–½çš„ä¿®å¤

### ä¿®å¤1: æ˜¾å¼åˆå§‹åŒ–å·¥å…·æ³¨å†Œè¡¨

åœ¨ `backend/cli/commands/chat.py` ä¸­ï¼š

```python
def handle_chat(user_input, ui_context):
    # 1. ç¡®ä¿å·¥å…·æ³¨å†Œè¡¨å·²åˆå§‹åŒ–ï¼ˆæ˜¾å¼è°ƒç”¨ï¼‰
    from daoyoucode.agents.tools import get_tool_registry
    tool_registry = get_tool_registry()
    console.print(f"[dim]âœ“ å·¥å…·æ³¨å†Œè¡¨å·²åˆå§‹åŒ– ({len(tool_registry.list_tools())} ä¸ªå·¥å…·)[/dim]")
    
    # 2. é…ç½®LLM
    # 3. æ³¨å†ŒAgent
    # 4. æ‰§è¡ŒSkill
```

### ä¿®å¤2: æ·»åŠ è°ƒè¯•ä¿¡æ¯

åœ¨ `backend/daoyoucode/agents/core/agent.py` ä¸­ï¼š

```python
# æ‰§è¡Œå·¥å…·å‰æ£€æŸ¥
if not tool_registry.get_tool(tool_name):
    print(f"   âš  è­¦å‘Š: å·¥å…· {tool_name} æœªåœ¨æ³¨å†Œè¡¨ä¸­æ‰¾åˆ°")
    print(f"   å¯ç”¨å·¥å…·: {', '.join(sorted(tool_registry.list_tools())[:10])}...")
```

### ä¿®å¤3: å¢å¼ºå•ä¾‹æ¨¡å¼

åœ¨ `backend/daoyoucode/agents/tools/registry.py` ä¸­ï¼š

```python
_registry_id = None  # ç”¨äºè°ƒè¯•

def get_tool_registry():
    global _tool_registry, _registry_id
    if _tool_registry is None:
        logger.info("åˆ›å»ºæ–°çš„å·¥å…·æ³¨å†Œè¡¨å®ä¾‹")
        _tool_registry = ToolRegistry()
        _registry_id = id(_tool_registry)
        _register_builtin_tools()
        logger.info(f"å·¥å…·æ³¨å†Œè¡¨ID: {_registry_id}")
    return _tool_registry
```

## æµ‹è¯•æ­¥éª¤

### æ­¥éª¤1: é‡æ–°æµ‹è¯•

```bash
cd backend
python -m cli.app chat
```

è§‚å¯Ÿè¾“å‡ºï¼š
1. æ˜¯å¦æ˜¾ç¤º"âœ“ å·¥å…·æ³¨å†Œè¡¨å·²åˆå§‹åŒ– (25 ä¸ªå·¥å…·)"
2. å¦‚æœå·¥å…·æ‰¾ä¸åˆ°ï¼Œæ˜¯å¦æ˜¾ç¤º"âš  è­¦å‘Š"å’Œå¯ç”¨å·¥å…·åˆ—è¡¨

### æ­¥éª¤2: æŸ¥çœ‹æ—¥å¿—

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼ŒæŸ¥çœ‹æ—¥å¿—ä¸­çš„å·¥å…·æ³¨å†Œè¡¨IDï¼š
- æ˜¯å¦åˆ›å»ºäº†å¤šä¸ªå®ä¾‹ï¼Ÿ
- å·¥å…·æ³¨å†Œæ˜¯å¦æˆåŠŸï¼Ÿ

### æ­¥éª¤3: ç®€åŒ–æµ‹è¯•

å¦‚æœé—®é¢˜æŒç»­ï¼Œå°è¯•ç®€å•çš„é—®é¢˜ï¼ˆä¸éœ€è¦å·¥å…·ï¼‰ï¼š
```
ä½  â€º ä½ å¥½
```

å¦‚æœè¿™ä¸ªèƒ½å·¥ä½œï¼Œè¯´æ˜é—®é¢˜ç¡®å®åœ¨å·¥å…·ç³»ç»Ÿã€‚

## å¤‡é€‰æ–¹æ¡ˆ

å¦‚æœä¸Šè¿°ä¿®å¤ä»ç„¶æ— æ•ˆï¼Œè€ƒè™‘ä»¥ä¸‹æ–¹æ¡ˆï¼š

### æ–¹æ¡ˆA: åœ¨Agentåˆå§‹åŒ–æ—¶æ³¨å†Œå·¥å…·

```python
class BaseAgent:
    def __init__(self, config):
        # ç¡®ä¿å·¥å…·å·²æ³¨å†Œ
        from ...tools import get_tool_registry
        self.tool_registry = get_tool_registry()
```

### æ–¹æ¡ˆB: ä½¿ç”¨å…¨å±€åˆå§‹åŒ–å‡½æ•°

åˆ›å»º `backend/daoyoucode/agents/init.py`:

```python
def initialize_agent_system():
    """åˆå§‹åŒ–Agentç³»ç»Ÿï¼ˆåŒ…æ‹¬å·¥å…·æ³¨å†Œè¡¨ï¼‰"""
    from .tools import get_tool_registry
    from .builtin import register_builtin_agents
    
    tool_registry = get_tool_registry()
    register_builtin_agents()
    
    return tool_registry
```

ç„¶ååœ¨chat.pyä¸­è°ƒç”¨ï¼š

```python
from daoyoucode.agents.init import initialize_agent_system
initialize_agent_system()
```

### æ–¹æ¡ˆC: å‚è€ƒdaoyouCodePilotçš„å®ç°

æŸ¥çœ‹ `daoyouCodePilot` é¡¹ç›®ä¸­å·¥å…·æ³¨å†Œçš„å®ç°æ–¹å¼ï¼Œçœ‹æ˜¯å¦æœ‰æ›´å¥½çš„æ–¹æ¡ˆã€‚

## ä¸‹ä¸€æ­¥

1. è¿è¡Œchatå‘½ä»¤ï¼Œè§‚å¯Ÿæ–°çš„è°ƒè¯•ä¿¡æ¯
2. å¦‚æœä»ç„¶å¤±è´¥ï¼Œæä¾›å®Œæ•´çš„è¾“å‡ºæ—¥å¿—
3. æ ¹æ®æ—¥å¿—ä¿¡æ¯å†³å®šä½¿ç”¨å“ªä¸ªå¤‡é€‰æ–¹æ¡ˆ

## é¢„æœŸç»“æœ

ä¿®å¤åï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
ä½  â€º ä½ èƒ½ç†è§£è¿™ä¸ªå·¥ç¨‹ä¹ˆ

âœ“ å·¥å…·æ³¨å†Œè¡¨å·²åˆå§‹åŒ– (25 ä¸ªå·¥å…·)

ğŸ”§ æ‰§è¡Œå·¥å…·: repo_map
   å‚æ•°: {'repo_path': '.'}
   â³ æ­£åœ¨æ‰§è¡Œ...
   âœ“ æ‰§è¡Œå®Œæˆ

AI â€º æ˜¯çš„ï¼Œæˆ‘å¯ä»¥ç†è§£è¿™ä¸ªå·¥ç¨‹ã€‚è¿™æ˜¯DaoyouCodeé¡¹ç›®...
```

è€Œä¸æ˜¯ï¼š

```
ğŸ”§ æ‰§è¡Œå·¥å…·: repo_map
   â³ æ­£åœ¨æ‰§è¡Œ...
   âœ— æ‰§è¡Œå¤±è´¥: Tool not found: repo_map
```
