# 工具调度与各智能体配置（是否最优）

> 当前机制、问题与已做优化。

---

## 1. 当前机制

- **单 Agent 编排**（react / simple）：Skill 的 `tools` 列表经 `filter_tool_names` 后，**整份**传给该 Skill 使用的唯一 Agent。工具调度 = **按 Skill 分配**，一个 Skill 一套工具。
- **多 Agent 编排**（multi_agent）：原先**所有子 Agent 共用**同一份 `skill.tools`。现已支持 **`agent_tools`**：在 skill.yaml 中可为每个 Agent 单独配置工具列表，未配置的 Agent 仍用 `skill.tools`。

因此：
- **单 Agent Skill**：是否最优取决于该 Skill 的 `tools` 是否与职责匹配（是否缺工具、是否多给无关工具）。
- **多 Agent Skill**：是否最优取决于是否配置了 **agent_tools**，为每个智能体只分配其职责所需工具。

---

## 2. 各 Skill / 智能体现状与评价

| Skill | 编排器 | Agent | 工具数 | 评价 |
|-------|--------|-------|--------|------|
| chat-assistant | react | MainAgent | 9 | 合理：项目理解 + 搜索 + 读写 + semantic_code_search；可选补 apply_patch、run_lint 做「改后验证」。 |
| edit-single | react | programmer | 7 | 已优化：含 lsp_diagnostics、run_lint，修改后必验证。 |
| sisyphus-orchestrator | multi_agent | sisyphus + 4 辅助 | 已按 Agent 分 | **已优化**：通过 agent_tools 为 sisyphus / code_analyzer / programmer / refactor_master / test_expert 分别配置，各司其职。 |
| oracle | react | oracle | 9 | 只读，合理：repo_map、LSP、ast_grep 等。 |
| librarian | react | librarian | 8 | 只读，合理。 |
| code-exploration | react | code_explorer | 7 | 只读，合理；可补 discover_project_docs 做「先文档后代码」。 |
| refactoring | simple | refactor_master | 9 | 缺 repo_map：重构前看调用关系会更好，建议补 repo_map。 |
| programming | simple | programmer | 10 | 合理；可选补 run_lint/run_test 做验证。 |
| testing | simple | test_expert | 6 | 合理。 |
| code-analysis | simple | code_analyzer | 6 | 合理；可补 discover_project_docs。 |
| complex-refactor | simple | 多 Agent | 11 | 可补 repo_map 以加强上下文。 |

---

## 3. 已做优化（工具调度侧）

1. **multi_agent 按 Agent 分配工具**
   - SkillConfig 新增 **`agent_tools`**（agent 名 → 工具名列表）。
   - multi_agent 内对每个 Agent 调用 **`_get_tools_for_agent(skill, agent.name)`**：有 `agent_tools[agent_name]` 则用其（再 filter_tool_names），否则用 skill 的 `tools`。
   - **sisyphus-orchestrator** 已配置 `agent_tools`：sisyphus 仅协调用 4 个；code_analyzer 含 LSP/符号；programmer 含写与 search_replace；refactor_master 含重构相关；test_expert 含 run_test/run_lint。各智能体工具集与职责一致，调度更优。

2. **filter_tool_names**
   - 编排器在传工具前统一用 `filter_tool_names(skill.tools)` 或 `filter_tool_names(agent_tools[name])`，避免配置了未注册工具名导致运行时报错。

---

## 4. 建议的进一步优化（可选）

| 项目 | 建议 |
|------|------|
| chat-assistant | 若希望对话内「改代码并验证」，可增加 `apply_patch`、`run_lint`。 |
| refactoring | 增加 `repo_map`，便于重构前看调用关系与模块边界。 |
| code-analysis / code-exploration | 增加 `discover_project_docs`，先文档后代码。 |
| complex-refactor | 增加 `repo_map`。 |
| programming | 增加 `run_lint`、`run_test`，改完可自检。 |

---

## 5. 结论

- **单 Agent Skill**：工具调度 = 该 Skill 的 `tools` 列表，整体已合理；按上表查漏补缺即可更优。
- **多 Agent Skill**：原先「所有子 Agent 共用一套 tools」**不是最优**；现已支持 **agent_tools**，且 **sisyphus-orchestrator 已按智能体配置**，工具调度已达「按职责分配」的最优形态。其他使用 multi_agent 的 Skill 若有多角色分工，建议同样配置 `agent_tools`。
