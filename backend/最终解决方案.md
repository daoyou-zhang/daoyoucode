# 最终解决方案 - 工具注册问题

## 问题总结

1. ✅ 工具注册代码正确
2. ✅ 单例模式正确
3. ✅ 测试脚本中工具能找到
4. ❌ 实际运行时工具找不到

## 根本原因

工具注册表在 `daoyoucode.agents.__init__.py` 中初始化：

```python
# 初始化工具注册表（确保工具在系统启动时就可用）
from .tools import get_tool_registry
_tool_registry = get_tool_registry()  # 触发工具注册
```

但是，当通过 `python -m cli.app chat` 运行时，模块导入顺序可能导致：
1. CLI先导入
2. 然后才导入agents模块
3. 工具注册表在Agent使用之前没有被初始化

## 解决方案

### 方案1: 在Agent基类中确保工具已注册（推荐）

修改 `backend/daoyoucode/agents/core/agent.py`：

```python
class BaseAgent:
    def __init__(self, config: AgentConfig):
        self.config = config
        self.logger = logging.getLogger(f"agent.{config.name}")
        
        # 确保工具注册表已初始化
        from ...tools import get_tool_registry
        self._tool_registry = get_tool_registry()
        self.logger.debug(f"工具注册表已初始化: {len(self._tool_registry.list_tools())} 个工具")
```

这样每个Agent实例化时都会确保工具已注册，而且由于单例模式，不会重复注册。

### 方案2: 在Executor中确保工具已注册

修改 `backend/daoyoucode/agents/executor.py`：

```python
async def execute_skill(...):
    # 确保工具注册表已初始化
    from .tools import get_tool_registry
    tool_registry = get_tool_registry()
    logger.debug(f"工具注册表: {len(tool_registry.list_tools())} 个工具")
    
    # 继续执行...
```

### 方案3: 创建统一的初始化函数

创建 `backend/daoyoucode/agents/init.py`:

```python
"""Agent系统统一初始化"""

_initialized = False

def initialize_agent_system():
    """初始化Agent系统（幂等操作）"""
    global _initialized
    
    if _initialized:
        return
    
    # 1. 初始化工具注册表
    from .tools import get_tool_registry
    tool_registry = get_tool_registry()
    
    # 2. 注册内置Agent
    from .builtin import register_builtin_agents
    register_builtin_agents()
    
    # 3. 注册内置编排器（已在__init__.py中完成）
    
    _initialized = True
    
    return tool_registry
```

然后在 `backend/cli/commands/chat.py` 中调用：

```python
from daoyoucode.agents.init import initialize_agent_system
initialize_agent_system()
```

## 推荐实施

我推荐使用 **方案1 + 方案3** 的组合：

1. 创建统一的初始化函数（方案3）
2. 在Agent基类中也确保工具已注册（方案1，作为双保险）

这样：
- ✅ 任何CLI命令都可以简单调用 `initialize_agent_system()`
- ✅ 即使忘记调用，Agent也会自动初始化
- ✅ 幂等操作，多次调用不会有问题
- ✅ 易于扩展其他交互方式

## 实施步骤

### 步骤1: 创建init.py

```bash
# 创建文件
backend/daoyoucode/agents/init.py
```

### 步骤2: 修改Agent基类

在 `BaseAgent.__init__` 中添加工具注册表初始化

### 步骤3: 在CLI命令中调用

在 `chat.py`, `edit.py` 等命令中调用 `initialize_agent_system()`

### 步骤4: 测试

```bash
cd backend
python -m cli.app chat
```

## 诊断工具

如果问题仍然存在，使用以下命令诊断：

```bash
# 1. 测试工具注册
python backend/test_tool_registry.py

# 2. 测试CLI环境
python backend/test_cli_env.py

# 3. 测试完整流程
python backend/test_chat_flow.py

# 4. 诊断工具注册表
python backend/diagnose_tools.py
```

## 检查LLM是否支持function calling

通义千问应该支持function calling，但需要确认：

1. API版本是否正确
2. 模型是否支持（qwen-max支持）
3. 请求格式是否正确

如果LLM不支持function calling，Agent会退化到普通对话模式，无法调用工具。

## 下一步

1. 实施方案1+3
2. 测试chat命令
3. 如果仍有问题，检查LLM的function calling支持
4. 查看详细日志确定问题所在
