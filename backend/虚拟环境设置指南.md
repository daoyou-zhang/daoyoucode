# 虚拟环境设置指南

## 为什么需要虚拟环境？

### 当前问题

你的全局Python环境中存在：
1. ❌ 旧项目 `daoyou-code-pilot` (0.0.0)
2. ❌ 依赖冲突：`huggingface-hub==0.36.0` vs `huggingface-hub==1.4.1`
3. ❌ 损坏的包分布（`~` 和 `~aoyou-code-pilot`）

### 虚拟环境的优势

✅ **隔离依赖**: 每个项目独立的依赖环境
✅ **避免冲突**: 不同项目可以使用不同版本的包
✅ **干净环境**: 不污染全局Python环境
✅ **易于管理**: 可以随时删除重建

---

## 快速设置（推荐）

### 方法1：使用venv（Python内置）

```bash
# 1. 进入项目目录
cd D:\daoyouspace\daoyoucode\backend

# 2. 创建虚拟环境
python -m venv .venv

# 3. 激活虚拟环境
# Windows CMD:
.venv\Scripts\activate.bat

# Windows PowerShell:
.venv\Scripts\Activate.ps1

# 4. 升级pip
python -m pip install --upgrade pip

# 5. 安装依赖
pip install -r requirements.txt

# 6. 验证安装
python test_embedding.py
```

### 方法2：使用conda

```bash
# 1. 创建虚拟环境
conda create -n daoyoucode python=3.11

# 2. 激活环境
conda activate daoyoucode

# 3. 进入项目目录
cd D:\daoyouspace\daoyoucode\backend

# 4. 安装依赖
pip install -r requirements.txt

# 5. 验证安装
python test_embedding.py
```

---

## 详细步骤

### 步骤1：创建虚拟环境

```powershell
# 进入backend目录
cd D:\daoyouspace\daoyoucode\backend

# 创建虚拟环境（名为.venv）
python -m venv .venv
```

**说明**:
- `.venv` 是虚拟环境目录名（可以改成其他名字）
- 这个目录会包含独立的Python解释器和包

---

### 步骤2：激活虚拟环境

**Windows CMD**:
```cmd
.venv\Scripts\activate.bat
```

**Windows PowerShell**:
```powershell
.venv\Scripts\Activate.ps1
```

**激活成功的标志**:
```
(.venv) PS D:\daoyouspace\daoyoucode\backend>
```
注意前面的 `(.venv)` 前缀

**如果PowerShell报错**:
```powershell
# 错误：无法加载文件，因为在此系统上禁止运行脚本
# 解决：临时允许脚本执行
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process

# 然后再次激活
.venv\Scripts\Activate.ps1
```

---

### 步骤3：升级pip

```bash
python -m pip install --upgrade pip
```

---

### 步骤4：安装依赖

```bash
pip install -r requirements.txt
```

**预期输出**:
```
Collecting httpx>=0.24.0
Collecting pyyaml>=6.0
Collecting jinja2>=3.0.0
Collecting sentence-transformers>=2.2.0
Collecting numpy>=1.24.0
Collecting torch>=2.0.0
...
Successfully installed ...
```

---

### 步骤5：验证安装

```bash
# 检查已安装的包
pip list

# 运行测试
python test_embedding.py
```

---

## 常用命令

### 激活/退出虚拟环境

```bash
# 激活（Windows PowerShell）
.venv\Scripts\Activate.ps1

# 激活（Windows CMD）
.venv\Scripts\activate.bat

# 退出
deactivate
```

---

### 查看当前环境

```bash
# 查看Python路径（应该指向.venv目录）
where python

# 查看已安装的包
pip list

# 查看特定包
pip show sentence-transformers
```

---

### 导出/导入依赖

```bash
# 导出当前环境的依赖
pip freeze > requirements.txt

# 从requirements.txt安装
pip install -r requirements.txt
```

---

### 删除虚拟环境

```bash
# 1. 退出虚拟环境
deactivate

# 2. 删除.venv目录
rmdir /s .venv  # Windows CMD
Remove-Item -Recurse -Force .venv  # PowerShell
```

---

## 清理全局环境（可选）

如果你想清理全局环境中的旧包：

```bash
# 1. 确保已退出虚拟环境
deactivate

# 2. 卸载旧项目
pip uninstall daoyou-code-pilot -y

# 3. 清理损坏的包
# 手动删除这些目录：
# D:\tools\python\Lib\site-packages\~*
# D:\tools\python\Lib\site-packages\~aoyou-code-pilot*

# 4. 验证
pip list | findstr daoyou
```

**警告**: 只清理 `daoyou-code-pilot` 相关的包，不要删除其他项目需要的包！

---

## 配置IDE使用虚拟环境

### VSCode

1. 打开命令面板（Ctrl+Shift+P）
2. 输入 "Python: Select Interpreter"
3. 选择 `.venv\Scripts\python.exe`

或者在 `.vscode/settings.json` 中添加：
```json
{
    "python.defaultInterpreterPath": "${workspaceFolder}/backend/.venv/Scripts/python.exe"
}
```

---

### PyCharm

1. File → Settings → Project → Python Interpreter
2. 点击齿轮图标 → Add
3. 选择 "Existing environment"
4. 选择 `.venv\Scripts\python.exe`

---

## .gitignore配置

确保虚拟环境不被提交到Git：

```gitignore
# 虚拟环境
.venv/
venv/
env/
ENV/

# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python

# 依赖
pip-log.txt
pip-delete-this-directory.txt
```

---

## 故障排除

### 问题1：PowerShell无法运行脚本

**错误**:
```
无法加载文件 .venv\Scripts\Activate.ps1，因为在此系统上禁止运行脚本
```

**解决**:
```powershell
# 临时允许（仅当前会话）
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process

# 或者使用CMD激活
.venv\Scripts\activate.bat
```

---

### 问题2：虚拟环境创建失败

**错误**:
```
Error: [WinError 5] 拒绝访问
```

**解决**:
1. 以管理员身份运行PowerShell/CMD
2. 或者选择其他目录创建虚拟环境

---

### 问题3：pip安装速度慢

**解决**: 使用国内镜像

```bash
# 临时使用
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 永久配置
pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
```

---

### 问题4：依赖冲突

**错误**:
```
ERROR: pip's dependency resolver does not currently take into account...
```

**解决**:
```bash
# 1. 删除虚拟环境重建
deactivate
Remove-Item -Recurse -Force .venv
python -m venv .venv
.venv\Scripts\Activate.ps1

# 2. 逐个安装依赖
pip install httpx pyyaml jinja2
pip install numpy torch
pip install sentence-transformers

# 3. 或者使用--no-deps跳过依赖检查（不推荐）
pip install --no-deps sentence-transformers
```

---

## 最佳实践

### 1. 始终使用虚拟环境

```bash
# ❌ 不好：直接在全局环境安装
pip install sentence-transformers

# ✅ 好：在虚拟环境中安装
.venv\Scripts\Activate.ps1
pip install sentence-transformers
```

---

### 2. 定期更新依赖

```bash
# 查看过期的包
pip list --outdated

# 更新特定包
pip install --upgrade sentence-transformers

# 更新所有包（谨慎）
pip list --outdated --format=freeze | %{$_.split('==')[0]} | %{pip install --upgrade $_}
```

---

### 3. 锁定依赖版本

```bash
# 导出精确版本
pip freeze > requirements-lock.txt

# 使用锁定版本安装
pip install -r requirements-lock.txt
```

---

## 快速启动脚本

创建 `activate.ps1` 脚本：

```powershell
# backend/activate.ps1

# 激活虚拟环境
& .\.venv\Scripts\Activate.ps1

# 显示Python版本
Write-Host "Python版本:" -ForegroundColor Green
python --version

# 显示已安装的关键包
Write-Host "`n关键依赖:" -ForegroundColor Green
pip show sentence-transformers torch numpy | Select-String "Name|Version"

Write-Host "`n虚拟环境已激活！" -ForegroundColor Green
Write-Host "运行测试: python test_embedding.py" -ForegroundColor Yellow
```

使用：
```powershell
cd backend
.\activate.ps1
```

---

## 总结

### 推荐工作流

1. **创建虚拟环境**（一次性）
   ```bash
   python -m venv .venv
   ```

2. **每次开发前激活**
   ```bash
   .venv\Scripts\Activate.ps1
   ```

3. **安装/更新依赖**
   ```bash
   pip install -r requirements.txt
   ```

4. **开发和测试**
   ```bash
   python test_embedding.py
   python -m pytest
   ```

5. **完成后退出**
   ```bash
   deactivate
   ```

### 核心优势

- ✅ 隔离项目依赖
- ✅ 避免版本冲突
- ✅ 易于复现环境
- ✅ 不污染全局环境

### 下一步

1. 创建虚拟环境
2. 安装依赖
3. 运行 `python test_embedding.py` 验证
4. 开始使用embedding功能
