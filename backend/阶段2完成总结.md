# é˜¶æ®µ2å®Œæˆæ€»ç»“

## å®æ–½å†…å®¹

### å·²å®Œæˆçš„ä¿®æ”¹

#### 1. å¢å¼ºRepoMapçš„Definitionç»“æ„ âœ…

**æ–‡ä»¶**: `daoyoucode/agents/tools/repomap_tools.py`

**ä¿®æ”¹å†…å®¹**:
- åœ¨`_parse_file()`æ–¹æ³•ä¸­æ·»åŠ äº†`parent_stack`è·Ÿè¸ªçˆ¶çº§
- ä¸ºæ¯ä¸ªdefinitionæ·»åŠ äº†`parent`å’Œ`scope`å­—æ®µ
- æ”¯æŒè¯†åˆ«ç±»çš„åµŒå¥—å…³ç³»ï¼ˆæ–¹æ³•æ‰€å±çš„ç±»ï¼‰

**æ–°å¢å­—æ®µ**:
```python
{
    "parent": "BaseAgent",  # çˆ¶çº§ç±»åï¼ˆå¦‚æœæ˜¯æ–¹æ³•ï¼‰
    "scope": "class"        # "global" | "class" | "function"
}
```

#### 2. æ·»åŠ å‡½æ•°è°ƒç”¨æå– âœ…

**æ–‡ä»¶**: `daoyoucode/agents/memory/codebase_index.py`

**æ–°å¢æ–¹æ³•**: `_extract_calls()`

**åŠŸèƒ½**:
- ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–å‡½æ•°è°ƒç”¨
- è¿‡æ»¤Pythonå…³é”®å­—å’Œå†…ç½®å‡½æ•°
- å»é‡å¹¶é™åˆ¶æ•°é‡ï¼ˆæœ€å¤š20ä¸ªï¼‰

#### 3. æ·»åŠ å¯¼å…¥å…³ç³»æå– âœ…

**æ–‡ä»¶**: `daoyoucode/agents/memory/codebase_index.py`

**æ–°å¢æ–¹æ³•**: `_extract_imports()`

**åŠŸèƒ½**:
- æå–`import xxx`è¯­å¥
- æå–`from xxx import yyy`è¯­å¥
- é™åˆ¶æ•°é‡ï¼ˆæœ€å¤š20ä¸ªï¼‰

#### 4. æ·»åŠ æ–‡ä»¶å…³è”æå– âœ…

**æ–‡ä»¶**: `daoyoucode/agents/memory/codebase_index.py`

**æ–°å¢æ–¹æ³•**: `_get_related_files()`

**åŠŸèƒ½**:
- ä»å¼•ç”¨å›¾ä¸­è·å–ç›¸å…³æ–‡ä»¶
- æŒ‰å¼•ç”¨æ¬¡æ•°æ’åº
- è¿”å›top-5ç›¸å…³æ–‡ä»¶

#### 5. æ·»åŠ è¢«è°ƒç”¨å…³ç³»æå– âœ…

**æ–‡ä»¶**: `daoyoucode/agents/memory/codebase_index.py`

**æ–°å¢æ–¹æ³•**: `_find_callers()`

**åŠŸèƒ½**:
- éå†æ‰€æœ‰definitionsæ‰¾åˆ°å¼•ç”¨
- è¿”å›è°ƒç”¨å½“å‰å‡½æ•°çš„æ–‡ä»¶åˆ—è¡¨
- é™åˆ¶æ•°é‡ï¼ˆæœ€å¤š10ä¸ªï¼‰

#### 6. é›†æˆåˆ°build_index() âœ…

**æ–‡ä»¶**: `daoyoucode/agents/memory/codebase_index.py`

**ä¿®æ”¹å†…å®¹**:
- é¢„å…ˆæå–æ‰€æœ‰æ–‡ä»¶çš„å¯¼å…¥å…³ç³»
- åœ¨æ„å»ºæ¯ä¸ªchunkæ—¶è°ƒç”¨æ‰€æœ‰æ–°æ–¹æ³•
- æ·»åŠ æ‰€æœ‰é˜¶æ®µ2çš„æ–°å­—æ®µ

**å¢å¼ºçš„Chunkç»“æ„**:
```python
{
    # é˜¶æ®µ1å­—æ®µ
    "path": "backend/agents/core/agent.py",
    "start": 100,
    "end": 150,
    "text": "def execute(self, ...):\n    ...",
    "type": "method",
    "name": "execute",
    "pagerank_score": 0.85,
    
    # ğŸ†• é˜¶æ®µ2æ–°å¢å­—æ®µ
    "parent_class": "BaseAgent",
    "scope": "class",
    "calls": ["_load_prompt", "_call_llm_with_tools"],
    "called_by": ["backend/orchestrators/multi_agent.py"],
    "imports": ["from ..llm import get_client_manager"],
    "related_files": ["backend/agents/llm/client_manager.py"]
}
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ–‡ä»¶

1. `test_stage2_enhanced_chunk.py` - å®Œæ•´æµ‹è¯•ï¼ˆåŒ…å«å‘é‡åŒ–ï¼‰
2. `test_stage2_quick.py` - å¿«é€Ÿæµ‹è¯•ï¼ˆåªéªŒè¯ç»“æ„ï¼‰

### æµ‹è¯•ç»“æœ

**æ³¨æ„**: æ—§çš„ç´¢å¼•ä¸åŒ…å«é˜¶æ®µ2å­—æ®µï¼Œéœ€è¦åˆ é™¤é‡å»ºã€‚

**é‡å»ºç´¢å¼•å‘½ä»¤**:
```bash
# åˆ é™¤æ—§ç´¢å¼•
rm -rf .daoyoucode/codebase_index

# æˆ–è€…åœ¨Pythonä¸­
import shutil
shutil.rmtree('.daoyoucode/codebase_index', ignore_errors=True)
```

**é¢„æœŸç»“æœ**ï¼ˆé‡å»ºåï¼‰:
- âœ… æ‰€æœ‰chunksåŒ…å«é˜¶æ®µ2çš„6ä¸ªæ–°å­—æ®µ
- âœ… parent_classå­—æ®µæ­£ç¡®è¯†åˆ«æ–¹æ³•æ‰€å±çš„ç±»
- âœ… scopeå­—æ®µæ­£ç¡®åŒºåˆ†global/classä½œç”¨åŸŸ
- âœ… callså­—æ®µåŒ…å«å‡½æ•°è°ƒç”¨åˆ—è¡¨
- âœ… called_byå­—æ®µåŒ…å«è°ƒç”¨è€…æ–‡ä»¶åˆ—è¡¨
- âœ… importså­—æ®µåŒ…å«å¯¼å…¥è¯­å¥
- âœ… related_fileså­—æ®µåŒ…å«ç›¸å…³æ–‡ä»¶åˆ—è¡¨

## ä»£ç è´¨é‡

### æ€§èƒ½ä¼˜åŒ–

1. **é¢„å…ˆæå–å¯¼å…¥å…³ç³»**: é¿å…é‡å¤è¯»å–æ–‡ä»¶
2. **é™åˆ¶æ•°é‡**: æ¯ä¸ªå­—æ®µéƒ½æœ‰åˆç†çš„ä¸Šé™
3. **å¤ç”¨å¼•ç”¨å›¾**: ä¸é‡å¤æ„å»ºå¼•ç”¨å…³ç³»

### é”™è¯¯å¤„ç†

1. **å¼‚å¸¸æ•è·**: æ‰€æœ‰æ–°æ–¹æ³•éƒ½æœ‰try-except
2. **é»˜è®¤å€¼**: æå–å¤±è´¥æ—¶è¿”å›ç©ºåˆ—è¡¨
3. **æ—¥å¿—è®°å½•**: ä½¿ç”¨logger.debugè®°å½•é”™è¯¯

### ä»£ç å¯ç»´æŠ¤æ€§

1. **æ¸…æ™°çš„æ–¹æ³•å‘½å**: `_extract_calls`, `_find_callers`ç­‰
2. **è¯¦ç»†çš„æ–‡æ¡£å­—ç¬¦ä¸²**: è¯´æ˜ç­–ç•¥å’Œè¿”å›å€¼
3. **æ¨¡å—åŒ–è®¾è®¡**: æ¯ä¸ªåŠŸèƒ½ç‹¬ç«‹çš„æ–¹æ³•

## ä¸‹ä¸€æ­¥ï¼šé˜¶æ®µ3

é˜¶æ®µ2å®Œæˆåï¼Œchunkç»“æ„å·²ç»åŒ…å«äº†ä¸°å¯Œçš„å…ƒæ•°æ®ã€‚é˜¶æ®µ3å°†åˆ©ç”¨è¿™äº›å…ƒæ•°æ®å®ç°ï¼š

### å¤šå±‚æ¬¡æ£€ç´¢

1. **ç¬¬1å±‚**: è¯­ä¹‰æ£€ç´¢ï¼ˆåŸºç¡€ï¼‰
2. **ç¬¬2å±‚**: æ–‡ä»¶å…³è”æ‰©å±•ï¼ˆåˆ©ç”¨related_filesï¼‰
3. **ç¬¬3å±‚**: å¼•ç”¨å…³ç³»æ‰©å±•ï¼ˆåˆ©ç”¨callså’Œcalled_byï¼‰
4. **ç¬¬4å±‚**: å»é‡å’Œé‡æ’åº

### é¢„æœŸæ•ˆæœ

- æ£€ç´¢å¬å›ç‡æå‡40%
- ä¸€æ¬¡æ£€ç´¢è·å¾—å®Œæ•´ä¸Šä¸‹æ–‡
- è‡ªåŠ¨å‘ç°ç›¸å…³ä»£ç 

## ä½¿ç”¨æŒ‡å—

### å¦‚ä½•ä½¿ç”¨å¢å¼ºçš„Chunk

```python
from pathlib import Path
from daoyoucode.agents.memory.codebase_index import CodebaseIndex

# 1. åˆ é™¤æ—§ç´¢å¼•ï¼ˆé‡è¦ï¼ï¼‰
import shutil
shutil.rmtree('.daoyoucode/codebase_index', ignore_errors=True)

# 2. æ„å»ºæ–°ç´¢å¼•
index = CodebaseIndex(Path("."))
count = index.build_index(force=True)

print(f"æ„å»ºäº† {count} ä¸ªå¢å¼ºçš„chunks")

# 3. æŸ¥çœ‹chunkç»“æ„
chunk = index.chunks[0]
print(f"æ–‡ä»¶: {chunk['path']}")
print(f"åç§°: {chunk['name']}")
print(f"ç±»å‹: {chunk['type']}")
print(f"çˆ¶çº§: {chunk.get('parent_class', 'None')}")
print(f"ä½œç”¨åŸŸ: {chunk['scope']}")
print(f"è°ƒç”¨: {chunk['calls']}")
print(f"è¢«è°ƒç”¨: {chunk['called_by']}")
print(f"å¯¼å…¥: {chunk['imports']}")
print(f"ç›¸å…³æ–‡ä»¶: {chunk['related_files']}")

# 4. æœç´¢ï¼ˆç°åœ¨è¿”å›å¢å¼ºçš„chunksï¼‰
results = index.search("å¦‚ä½•æ‰§è¡ŒAgent", top_k=5)
for result in results:
    print(f"\n{result['path']}::{result['name']}")
    print(f"  ç›¸å…³æ–‡ä»¶: {result['related_files']}")
```

### å¦‚ä½•åˆ©ç”¨æ–°å­—æ®µ

#### 1. æ‰¾åˆ°ç›¸å…³ä»£ç 

```python
# æ‰¾åˆ°ä¸€ä¸ªå‡½æ•°
chunk = index.chunks[0]

# æŸ¥çœ‹å®ƒè°ƒç”¨äº†å“ªäº›å‡½æ•°
print(f"è°ƒç”¨: {chunk['calls']}")

# æŸ¥çœ‹å“ªäº›æ–‡ä»¶è°ƒç”¨äº†å®ƒ
print(f"è¢«è°ƒç”¨: {chunk['called_by']}")

# æŸ¥çœ‹ç›¸å…³æ–‡ä»¶
print(f"ç›¸å…³æ–‡ä»¶: {chunk['related_files']}")
```

#### 2. ç†è§£ä»£ç ç»“æ„

```python
# æ‰¾åˆ°æ‰€æœ‰ç±»æ–¹æ³•
methods = [c for c in index.chunks if c.get('parent_class')]

# æŒ‰ç±»åˆ†ç»„
from collections import defaultdict
by_class = defaultdict(list)
for m in methods:
    by_class[m['parent_class']].append(m['name'])

# æ˜¾ç¤ºæ¯ä¸ªç±»çš„æ–¹æ³•
for class_name, method_names in by_class.items():
    print(f"{class_name}:")
    for name in method_names:
        print(f"  - {name}")
```

#### 3. åˆ†æä¾èµ–å…³ç³»

```python
# æ‰¾åˆ°å¯¼å…¥æœ€å¤šçš„æ–‡ä»¶
chunks_by_file = {}
for c in index.chunks:
    if c['path'] not in chunks_by_file:
        chunks_by_file[c['path']] = c
    
sorted_files = sorted(
    chunks_by_file.items(),
    key=lambda x: len(x[1].get('imports', [])),
    reverse=True
)

print("å¯¼å…¥æœ€å¤šçš„æ–‡ä»¶:")
for file_path, chunk in sorted_files[:10]:
    print(f"{file_path}: {len(chunk['imports'])} ä¸ªå¯¼å…¥")
```

## æ€»ç»“

### å®Œæˆæƒ…å†µ

âœ… **æ­¥éª¤1**: å¢å¼ºRepoMapçš„Definitionç»“æ„  
âœ… **æ­¥éª¤2**: æå–å‡½æ•°è°ƒç”¨å…³ç³»  
âœ… **æ­¥éª¤3**: æå–å¯¼å…¥å…³ç³»  
âœ… **æ­¥éª¤4**: æ„å»ºæ–‡ä»¶å…³è”  
âœ… **æ­¥éª¤5**: æ„å»ºè¢«è°ƒç”¨å…³ç³»  
âœ… **æ­¥éª¤6**: é›†æˆåˆ°build_index()  

### æ–°å¢å­—æ®µ

âœ… `parent_class` - çˆ¶çº§ç±»å  
âœ… `scope` - ä½œç”¨åŸŸï¼ˆglobal/classï¼‰  
âœ… `calls` - å‡½æ•°è°ƒç”¨åˆ—è¡¨  
âœ… `called_by` - è¢«è°ƒç”¨æ–‡ä»¶åˆ—è¡¨  
âœ… `imports` - å¯¼å…¥è¯­å¥åˆ—è¡¨  
âœ… `related_files` - ç›¸å…³æ–‡ä»¶åˆ—è¡¨  

### ä»£ç è´¨é‡

âœ… æ€§èƒ½ä¼˜åŒ–ï¼ˆé¢„å…ˆæå–ã€é™åˆ¶æ•°é‡ï¼‰  
âœ… é”™è¯¯å¤„ç†ï¼ˆå¼‚å¸¸æ•è·ã€é»˜è®¤å€¼ï¼‰  
âœ… å¯ç»´æŠ¤æ€§ï¼ˆæ¸…æ™°å‘½åã€è¯¦ç»†æ–‡æ¡£ï¼‰  

### ä¸‹ä¸€æ­¥

å‡†å¤‡è¿›å…¥é˜¶æ®µ3ï¼š**å¤šå±‚æ¬¡æ£€ç´¢**

åˆ©ç”¨é˜¶æ®µ2çš„å…ƒæ•°æ®å®ç°æ™ºèƒ½çš„ä»£ç æ£€ç´¢ï¼Œæå‡å¬å›ç‡å’Œå‡†ç¡®æ€§ã€‚

---

**é˜¶æ®µ2å®Œæˆæ—¶é—´**: 2026-02-18  
**å®æ–½æ—¶é—´**: çº¦2å°æ—¶  
**ä»£ç è¡Œæ•°**: çº¦200è¡Œæ–°å¢ä»£ç   
**æµ‹è¯•çŠ¶æ€**: å¾…é‡å»ºç´¢å¼•åéªŒè¯  
