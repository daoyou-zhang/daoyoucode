# daoyoucode 核心设计文档

> **这是唯一需要的核心文档**  
> **设计原则**: 智能体为核心，模块化，易扩展

---

## 📐 系统架构（简化版）

```
用户界面 (CLI/TUI/Web/Desktop)
        ↓
    API网关 (FastAPI)
        ↓
    智能编排器 (核心)
        ↓
    智能体层 (13个智能体) ← 核心功能
        ↓
    工具层 (LSP/Git/文件/搜索)
        ↓
    LLM层 (Qwen/DeepSeek/Claude/GPT)
```

---

## 🤖 智能体系统（核心中的核心）

### 主要智能体（全部保留）

| 智能体 | 模型 | 职责 | 必要性 |
|--------|------|------|--------|
| **Sisyphus** | Claude Opus 4.5 | 主编排器，任务分解和执行 | ⭐⭐⭐⭐⭐ |
| **ChineseEditor** | Qwen Coder Plus | 中文代码编辑专家 | ⭐⭐⭐⭐⭐ |
| **Oracle** | GPT 5.2 | 架构顾问，高IQ分析 | ⭐⭐⭐⭐⭐ |
| **Librarian** | GLM 4.7 | 文档查找，代码搜索 | ⭐⭐⭐⭐⭐ |
| **Explore** | Grok Code | 快速代码探索 | ⭐⭐⭐⭐ |
| **RefactorMaster** | Claude Opus 4.5 | 代码重构专家 | ⭐⭐⭐⭐ |
| **TestExpert** | DeepSeek Coder | 测试编写和修复 | ⭐⭐⭐⭐ |
| **FrontendExpert** | Gemini 3 Pro | 前端UI/UX | ⭐⭐⭐ |
| **BackendExpert** | Qwen Max | 后端逻辑 | ⭐⭐⭐ |
| **Prometheus** | Claude Opus 4.5 | 战略规划师 | ⭐⭐⭐ |
| **Metis** | Claude Sonnet 4.5 | 计划顾问 | ⭐⭐ |
| **Momus** | Claude Sonnet 4.5 | 计划审查 | ⭐⭐ |
| **Multimodal** | Gemini 3 Flash | 图像/PDF分析 | ⭐⭐ |

### 智能体协作方式

```python
# 用户请求
user_request = "重构登录模块，添加测试"

# Sisyphus分析并调度
Sisyphus:
  1. 调用 Explore → 找到登录相关文件
  2. 调用 Oracle → 分析架构问题
  3. 调用 RefactorMaster → 执行重构
  4. 调用 TestExpert → 编写测试
  5. 聚合结果 → 返回用户
```

---

## ✏️ 编辑系统（精简版）

### 核心编辑模式（3种）

| 模式 | 说明 | 何时使用 |
|------|------|---------|
| **SmartEdit** | 智能编辑（合并4种） | 代码修改（自动选择最佳方式） |
| **Ask** | 问答模式 | 不修改代码，只回答问题 |
| **Architect** | 架构分析 | 分析代码结构 |

### SmartEdit 内部逻辑

```python
class SmartEdit:
    def edit(self, file, instruction):
        # 自动选择最佳编辑方式
        if file_size < 100行:
            return self.whole_file_edit()  # 小文件直接重写
        elif change_scope == "small":
            return self.block_edit()       # 小改动用块编辑
        elif has_complex_changes:
            return self.patch_edit()       # 复杂改动用patch
        else:
            return self.diff_edit()        # 默认用diff
```

**用户无需关心内部实现，只需要说"修改这个文件"即可！**

---

## 📁 项目结构（精简版）

```
daoyoucode/
│
├── backend/                    # Python后端
│   ├── daoyoucode/
│   │   ├── api/               # FastAPI接口
│   │   ├── core/              # 核心编排器
│   │   ├── agents/            # 13个智能体 ← 核心
│   │   ├── tools/             # 工具集
│   │   ├── llm/               # LLM集成
│   │   └── plugins/           # 插件系统
│   └── cli/                   # CLI工具
│
├── frontend/                   # React前端
│   ├── packages/
│   │   ├── shared/            # 共享代码
│   │   ├── tui/               # 终端UI
│   │   ├── web/               # Web应用
│   │   └── desktop/           # 桌面应用
│
├── plugins/                    # 独立插件
│   ├── lsp-plugin/            # LSP工具
│   ├── git-plugin/            # Git工具
│   └── custom-*/              # 你的新想法
│
└── docs/                       # 文档
```

---

## 🔧 核心工具集

### 必备工具

1. **LSP工具** (from oh-my-opencode)
   - 代码诊断、重命名、跳转、引用查找

2. **Git工具** (融合最佳)
   - 自动提交、智能commit、原子提交、历史分析

3. **文件工具** (from daoyou)
   - 读写、列表、创建、删除

4. **搜索工具** (融合)
   - 文本搜索、正则搜索、AST搜索、语义搜索

5. **测试工具** (from daoyou)
   - 运行测试、自动修复

---

## 🎨 用户界面

### 4种界面（全保留）

1. **CLI** (Python) - 快速命令
   ```bash
   daoyoucode edit main.py "添加日志"
   ```

2. **TUI** (React Ink) - 美观终端
   - 实时进度、代码高亮

3. **Web** (React) - 浏览器访问
   - 可视化配置、团队协作

4. **Desktop** (Electron) - 桌面应用
   - 原生体验、离线可用

---

## 🔌 扩展系统

### 3种扩展方式

1. **插件系统** - 独立功能模块
   ```python
   class MyPlugin(BasePlugin):
       def execute(self, action, params):
           # 你的新想法
   ```

2. **Hook系统** - 拦截和修改行为
   ```python
   @hook("PreToolUse")
   def my_hook(context):
       # 在工具执行前做些什么
   ```

3. **Skill系统** - 可复用的Prompt模板
   ```yaml
   # skills/my-skill/skill.yaml
   name: my-skill
   description: 我的技能
   ```

---

## 🚀 开发计划（精简版）

### 阶段1: 核心引擎（4周）
- [ ] 实现Orchestrator编排器
- [ ] 实现5个核心智能体（Sisyphus, ChineseEditor, Oracle, Librarian, Explore）
- [ ] 集成LLM（Qwen, DeepSeek, Claude, GPT）
- [ ] 实现SmartEdit编辑器

### 阶段2: 工具集成（3周）
- [ ] LSP工具
- [ ] Git工具
- [ ] 文件和搜索工具
- [ ] 测试工具

### 阶段3: 用户界面（3周）
- [ ] CLI工具
- [ ] TUI界面
- [ ] Web应用
- [ ] Desktop应用

### 阶段4: 扩展系统（2周）
- [ ] 插件系统
- [ ] Hook系统
- [ ] Skill系统

### 阶段5: 完善和优化（2周）
- [ ] 添加剩余智能体
- [ ] 性能优化
- [ ] 文档完善
- [ ] 测试覆盖

**总计: 14周完成核心功能**

---

## 💡 使用示例

### 简单任务
```bash
# CLI直接使用
daoyoucode edit main.py "添加日志功能"

# 自动流程：
# 1. ChineseEditor理解中文指令
# 2. SmartEdit智能选择编辑方式
# 3. 应用修改
# 4. 自动提交Git
```

### 复杂任务
```bash
# 启动交互式对话
daoyoucode chat

> 重构登录模块，添加测试，优化性能

# 自动流程：
# 1. Sisyphus分析任务
# 2. Explore找到相关文件
# 3. Oracle分析架构
# 4. RefactorMaster执行重构
# 5. TestExpert编写测试
# 6. 并行执行，实时反馈
```

### 新想法作为插件
```bash
# 创建新插件
daoyoucode plugin create my-idea

# 实现插件逻辑
# plugins/my-idea/src/__init__.py

# 启用插件
daoyoucode plugin enable my-idea

# 使用插件
daoyoucode my-idea do-something
```

---

## 🎯 核心优势

1. **智能体为核心** - 13个专业智能体协作
2. **中文优先** - 深度优化中文体验
3. **智能编辑** - 自动选择最佳编辑方式
4. **模块化** - 每个功能独立模块
5. **易扩展** - 插件/Hook/Skill三种扩展方式
6. **多界面** - CLI/TUI/Web/Desktop全覆盖
7. **成本优化** - 智能模型选择

---

## 📊 技术栈

| 层级 | 技术 | 原因 |
|------|------|------|
| 后端 | Python + FastAPI | 利用daoyou代码，高性能 |
| 前端 | React + TypeScript | 统一UI技术栈 |
| CLI | Python Click | 快速开发 |
| TUI | React Ink | 美观终端 |
| 桌面 | Electron | 跨平台 |
| 数据库 | SQLite | 轻量级 |
| 通信 | REST + WebSocket | 实时通信 |

---

## 🎬 下一步

1. **创建项目结构** - 按照上面的目录结构
2. **实现核心编排器** - Orchestrator
3. **实现5个核心智能体** - 先实现最重要的
4. **集成LLM** - Qwen, DeepSeek, Claude, GPT
5. **实现SmartEdit** - 智能编辑器
6. **开发CLI** - 命令行工具

**从最核心的开始，逐步扩展！**

